<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IPAT - Natan Moreira</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; position: relative; min-height: 100vh; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; position: relative; z-index: 10; }
        .negative { color: #ef4444; font-weight: bold; }
        .positive { color: #10b981; font-weight: bold; }
        
        /* Modais */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background: white; border-radius: 8px; width: 95%; max-height: 95vh; overflow-y: auto; padding: 20px; }
        
        /* Tabela */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left; }
        th { background-color: #f9fafb; font-weight: 600; white-space: nowrap; }
        tr:hover { background-color: #f0f9ff; cursor: pointer; }
        
        /* Estilo para o multiselect e busca */
        .checkbox-list { max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; padding: 5px; border-radius: 4px; background: #fff; margin-top: 5px; }
        .checkbox-item { display: flex; align-items: center; margin-bottom: 2px; }
        .checkbox-item input { margin-right: 8px; }
        .checkbox-item label { font-size: 0.8rem; color: #374151; cursor: pointer; white-space: nowrap; }
        
        /* KPI Cards Interativos */
        .kpi-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }

        /* MARCA D'ÁGUA */
        .watermark-overlay {
            position: fixed;
            top: 5px;
            left: 10px;
            font-size: 10px;
            font-weight: 700;
            color: rgba(0, 0, 0, 0.4);
            pointer-events: none;
            z-index: 9999;
            white-space: nowrap;
            user-select: none;
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-4 md:p-6 pt-8"> <div class="watermark-overlay">CRIADO POR NATAN MOREIRA EM 07/02/2026</div>

    <div class="max-w-full mx-auto space-y-6 relative z-10">
        
        <div class="card space-y-4">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Dashboard IPAT</h1>
                    <p class="text-sm text-gray-600">Sistema de Análise de Produtividade Ajustada</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="fazerBackup()" class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">Backup JSON</button>
                    <label class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700 cursor-pointer">
                        Restaurar
                        <input type="file" id="fileRestore" accept=".json" class="hidden" onchange="restaurarBackup(this)">
                    </label>
                    <button onclick="limparDados()" class="bg-red-100 text-red-700 px-3 py-1 rounded text-xs hover:bg-red-200">Limpar</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1">1. Detalhamento de Chamadas (.csv)</label>
                    <input type="file" id="fileChamadas" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 mb-1">2. Eventos Atendentes (.csv)</label>
                    <input type="file" id="fileEventos" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-start">
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-700">Data Inicial</label>
                    <input type="date" id="dataInicioFilter" class="border rounded p-1 w-full text-sm">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-700">Data Final</label>
                    <input type="date" id="dataFimFilter" class="border rounded p-1 w-full text-sm">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-700">Taxa Meta (%)</label>
                    <input type="number" id="taxaOcupacao" value="85" class="border rounded p-1 w-full text-sm">
                </div>
                 <div class="md:col-span-2 flex items-end h-full pt-4">
                    <button onclick="processarDados()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full font-bold shadow">CALCULAR</button>
                </div>
                
                <div class="md:col-span-4">
                    <div class="flex justify-between items-end mb-1">
                        <label class="block text-xs font-bold text-gray-700">Filas (Selecione)</label>
                        <div class="space-x-1">
                            <button onclick="toggleFilas(true)" class="text-[10px] text-blue-600 underline">Todas</button>
                            <button onclick="toggleFilas(false)" class="text-[10px] text-blue-600 underline">Nenhuma</button>
                        </div>
                    </div>
                    <input type="text" id="filaSearch" onkeyup="filtrarFilas()" placeholder="Pesquisar fila..." class="w-full text-xs border rounded p-1 mb-1 focus:outline-none focus:border-blue-500">
                    
                    <div id="filaContainer" class="checkbox-list">
                        <p class="text-gray-400 text-xs italic p-1">Carregue o arquivo de chamadas...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="kpiContainer" class="grid grid-cols-2 md:grid-cols-5 gap-3 hidden">
            <div class="card kpi-card text-center p-3 border-l-4 border-blue-500" onclick="showKpiBreakdown('recebidas')">
                <h3 class="text-xs text-gray-500 font-bold uppercase">Recebidas</h3>
                <p class="text-2xl font-bold text-blue-600" id="kpiRecebidas">-</p>
                <p class="text-[10px] text-gray-400">Total Selecionado (Ver Capacidade)</p>
            </div>
            <div class="card kpi-card text-center p-3 border-l-4 border-green-500" onclick="showKpiBreakdown('atendidas')">
                <h3 class="text-xs text-gray-500 font-bold uppercase">Atendidas</h3>
                <p class="text-2xl font-bold text-green-600" id="kpiAtendidas">-</p>
            </div>
            <div class="card kpi-card text-center p-3 border-l-4 border-purple-500" onclick="showKpiBreakdown('ocupacao')">
                <h3 class="text-xs text-gray-500 font-bold uppercase">Ocupação Média</h3>
                <p class="text-2xl font-bold text-purple-600" id="kpiOcupacao">-</p>
            </div>
            <div class="card kpi-card text-center p-3 border-l-4 border-orange-500" onclick="showKpiBreakdown('ocioso')">
                <h3 class="text-xs text-gray-500 font-bold uppercase">Ocioso Médio</h3>
                <p class="text-2xl font-bold text-orange-600" id="kpiOcioso">-</p>
            </div>
            <div class="card kpi-card text-center p-3 border-l-4 border-gray-800" onclick="showKpiBreakdown('ipat')">
                <h3 class="text-xs text-gray-500 font-bold uppercase">IPAT Médio</h3>
                <p class="text-2xl font-bold" id="kpiIpat">-</p>
            </div>
        </div>

        <div id="chartContainer" class="card hidden">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-lg font-bold text-gray-800">Análise: Capacidade vs Realizado e TMA</h2>
                <div class="text-xs text-gray-500 flex gap-4">
                    <span class="flex items-center"><div class="w-3 h-3 bg-green-500 mr-1 rounded"></div> Barras: Atendidas</span>
                    <span class="flex items-center"><div class="w-3 h-3 bg-blue-600 mr-1"></div> Linha: Estimativa</span>
                    <span class="flex items-center"><div class="w-3 h-3 bg-orange-500 mr-1 rounded-full"></div> Linha: TMA (Minutos)</span>
                </div>
            </div>
            <div style="position: relative; height: 350px; width: 100%;">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <div id="mainTableCard" class="card hidden">
            <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2">Performance por Colaborador</h2>
            <div class="table-container">
                <table id="tabelaAgentes">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Dias</th>
                            <th title="Total estimado de chamadas baseadas na ocupação">Estimativa</th>
                            <th title="Total de chamadas atendidas">Atendidas</th>
                            <th>Jornada Líq.</th>
                            <th>Tempo Falado</th>
                            <th>Pausas Prod.</th>
                            <th>Pausas Improd.</th>
                            <th>Tempo Ocioso</th>
                            <th>Ocupação</th>
                            <th>IPAT</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="modalDetalhe" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800" id="modalTitle">Detalhes</h2>
                <button onclick="closeModal('modalDetalhe')" class="text-gray-500 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div class="table-container">
                <table id="tabelaDetalheIntervalos">
                    <thead>
                        <tr>
                            <th>Intervalo</th>
                            <th>Status</th>
                            <th>Atendidas</th>
                            <th>Estimativa</th>
                            <th>Tempo Atend.</th>
                            <th>Tempo Ocioso</th>
                            <th>Pausa (Tipo)</th>
                            <th>Dur. Pausa</th>
                            <th>Acumulado Pausas</th>
                        </tr>
                    </thead>
                    <tbody id="modalBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalKPI" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800" id="modalKpiTitle">Ranking KPI</h2>
                <button onclick="closeModal('modalKPI')" class="text-gray-500 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div class="table-container">
                <table id="tabelaKpiBreakdown">
                    <thead>
                        <tr>
                            <th>Colaborador</th>
                            <th id="kpiColHeader" class="text-right">Valor</th>
                        </tr>
                    </thead>
                    <tbody id="modalKpiBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ESTADO GLOBAL
        // ==========================================
        let rawDataChamadas = [];
        let rawDataEventos = [];
        let globalAgentesData = []; // Armazena dados processados para uso nos KPIs
        let performanceChartInstance = null;
        
        // Configurações de Pausa
        const PAUSAS_PRODUTIVAS = ['pausa registro', 'registro', 'pausa cancelamento de plano', 'pausa mesa do acerto', 'pausa feedback', 'feedback'];
        const PAUSAS_IMPRODUTIVAS = ['pausa agua', 'agua', 'pausa banheiro', 'banheiro'];
        const PAUSAS_DEDUCAO_LIQUIDA = ['lanche', 'almoço', 'jantar'];
        const PAUSAS_10 = ['pausa 10', '10 min', 'descanso 10']; // Adicionado para cálculo de ocioso

        // ==========================================
        // UTILITÁRIOS
        // ==========================================
        function timeToSeconds(timeStr) {
            if (!timeStr) return 0;
            let cleanStr = timeStr.split(' ')[0]; 
            const p = cleanStr.split(':');
            if (p.length < 2) return 0;
            let s = 0;
            if (p.length === 3) s = (+p[0]) * 3600 + (+p[1]) * 60 + (+p[2]);
            else s = (+p[0]) * 60 + (+p[1]);
            return s;
        }

        function secondsToTime(secs) {
            if (isNaN(secs) || secs < 0) secs = 0;
            const h = Math.floor(secs / 3600);
            const m = Math.floor((secs % 3600) / 60);
            const s = Math.floor(secs % 60);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            
            if (dateStr.includes('-')) {
                if (dateStr.includes('T') || dateStr.includes(' ')) return new Date(dateStr.replace(/-/g, '/'));
                return new Date(dateStr + ' 00:00:00');
            }
            if (dateStr.includes('/')) {
                const parts = dateStr.split(' ');
                const dataParts = parts[0].split('/');
                let dateObj;
                if (dataParts[2].length === 4) {
                    dateObj = new Date(dataParts[2], dataParts[1]-1, dataParts[0]);
                } else {
                    dateObj = new Date(dateStr);
                }
                if (parts.length > 1) {
                    const timeParts = parts[1].split(':');
                    dateObj.setHours(timeParts[0], timeParts[1], timeParts[2] || 0);
                }
                return dateObj;
            }
            return new Date(dateStr);
        }

        // ==========================================
        // CARREGAMENTO ARQUIVOS
        // ==========================================
        document.getElementById('fileChamadas').addEventListener('change', (e) => loadCSV(e.target.files[0], 'chamadas'));
        document.getElementById('fileEventos').addEventListener('change', (e) => loadCSV(e.target.files[0], 'eventos'));

        function loadCSV(file, type) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                if (lines.length < 6) {
                    alert('Arquivo inválido (menos de 6 linhas).');
                    return;
                }
                const csvContent = lines.slice(5).join('\n');
                
                Papa.parse(csvContent, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: ";", 
                    complete: function(results) {
                        if (type === 'chamadas') {
                            rawDataChamadas = results.data;
                            preencherFiltroFilas();
                        } else {
                            rawDataEventos = results.data;
                        }
                    }
                });
            };
            reader.readAsText(file, 'ISO-8859-1');
        }

        // ==========================================
        // FILTROS & FILAS
        // ==========================================
        function preencherFiltroFilas() {
            const container = document.getElementById('filaContainer');
            container.innerHTML = '';
            
            const filas = new Set();
            rawDataChamadas.forEach(r => {
                if (r.nomeFila) filas.add(r.nomeFila.replace(/"/g, '').trim());
            });
            
            const sortedFilas = Array.from(filas).sort();

            if (sortedFilas.length === 0) {
                container.innerHTML = '<p class="text-xs text-red-500">Nenhuma fila encontrada.</p>';
                return;
            }

            sortedFilas.forEach(f => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = f;
                checkbox.checked = true;
                checkbox.id = 'fila_' + f.replace(/\s+/g, '_');
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.innerText = f;

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // Nova Função de Pesquisa
        function filtrarFilas() {
            const termo = document.getElementById('filaSearch').value.toLowerCase();
            const items = document.querySelectorAll('.checkbox-item');
            items.forEach(item => {
                const text = item.querySelector('label').innerText.toLowerCase();
                if (text.includes(termo)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function toggleFilas(status) {
            const checkboxes = document.querySelectorAll('#filaContainer input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if(cb.parentElement.style.display !== 'none') {
                    cb.checked = status;
                }
            });
        }

        // ==========================================
        // PROCESSAMENTO DE DADOS
        // ==========================================
        function processarDados() {
            if (rawDataChamadas.length === 0 || rawDataEventos.length === 0) {
                alert("Por favor, carregue os arquivos CSV de Chamadas e Eventos.");
                return;
            }

            // --- 1. Capturar Parâmetros ---
            const taxaOcupacao = parseFloat(document.getElementById('taxaOcupacao').value) / 100;
            
            const dtInicioVal = document.getElementById('dataInicioFilter').value;
            const dtFimVal = document.getElementById('dataFimFilter').value;

            let dataInicioFiltro = null;
            if (dtInicioVal) {
                const [y, m, d] = dtInicioVal.split('-');
                dataInicioFiltro = new Date(y, m-1, d, 0, 0, 0); 
            }

            let dataFimFiltro = null;
            if (dtFimVal) {
                const [y, m, d] = dtFimVal.split('-');
                dataFimFiltro = new Date(y, m-1, d, 23, 59, 59, 999); 
            }

            const checkboxes = document.querySelectorAll('#filaContainer input[type="checkbox"]:checked');
            const filasSelecionadas = Array.from(checkboxes).map(cb => cb.value);

            if (filasSelecionadas.length === 0) {
                alert("Selecione pelo menos uma fila.");
                return;
            }

            // --- 2. Filtrar Chamadas ---
            let chamadasFiltradas = rawDataChamadas.filter(c => {
                const d = parseDate(c.data);
                if (dataInicioFiltro && d < dataInicioFiltro) return false;
                if (dataFimFiltro && d > dataFimFiltro) return false;
                
                const filaNome = c.nomeFila ? c.nomeFila.replace(/"/g, '').trim() : '';
                if (!filasSelecionadas.includes(filaNome)) return false;

                return true;
            });

            // --- 3. Criar Intervalos (10 min) ---
            let intervalos = {};

            const getIntervalKey = (dateObj) => {
                const m = Math.floor(dateObj.getMinutes() / 10) * 10;
                const h = dateObj.getHours();
                return `${dateObj.getFullYear()}/${String(dateObj.getMonth()+1).padStart(2,'0')}/${String(dateObj.getDate()).padStart(2,'0')} ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            };

            chamadasFiltradas.forEach(c => {
                const horaStr = c.horaEntradaPos.split(' ')[0];
                const dataBase = parseDate(c.data);
                const [hh, mm, ss] = horaStr.split(':');
                dataBase.setHours(hh, mm, ss || 0);

                const key = getIntervalKey(dataBase);
                if (!intervalos[key]) intervalos[key] = { recebidas: 0, agentes: new Set(), chamadas: [] };
                
                intervalos[key].recebidas++;
                if (c.tipo === 'Atendida') {
                    const atendente = c.nomeAtendente ? c.nomeAtendente.replace(/"/g, '').trim() : "N/A";
                    intervalos[key].chamadas.push({ atendente: atendente, duracao: timeToSeconds(c.tempoAtendimento) });
                }
            });

            // --- 4. Processar Eventos (Jornada) ---
            let eventosFiltrados = rawDataEventos.filter(e => {
                const d = parseDate(e.data);
                if (dataInicioFiltro && d < dataInicioFiltro) return false;
                if (dataFimFiltro && d > dataFimFiltro) return false;
                return true;
            });

            let agentesPorDia = {};

            eventosFiltrados.forEach(e => {
                const nome = e.nomeAtendente.replace(/"/g, '').trim();
                const dataContabil = parseDate(e.data);
                const key = `${nome}|${dataContabil.toISOString().split('T')[0]}`;

                if (!agentesPorDia[key]) agentesPorDia[key] = { 
                    nome: nome, 
                    data: dataContabil, 
                    logins: [], 
                    pausas: []
                };

                const eventoTipo = e.evento.toLowerCase();
                if (eventoTipo === 'login') {
                    agentesPorDia[key].logins.push({ inicio: parseDate(e.dataInicio), fim: parseDate(e.dataFim) });
                } else if (eventoTipo === 'pausa') {
                    agentesPorDia[key].pausas.push({
                        tipo: e.nomePausa ? e.nomePausa.toLowerCase().replace(/"/g, '') : '',
                        inicio: parseDate(e.dataInicio),
                        fim: parseDate(e.dataFim)
                    });
                }
            });

            // --- 5. Mapear Supply (Agentes nos Intervalos) ---
            Object.values(agentesPorDia).forEach(agenteDia => {
                agenteDia.logins.forEach(sessao => {
                    let cursor = new Date(sessao.inicio);
                    cursor.setMinutes(Math.floor(cursor.getMinutes()/10)*10, 0, 0);
                    while (cursor < sessao.fim) {
                        const key = getIntervalKey(cursor);
                        if (!intervalos[key]) intervalos[key] = { recebidas: 0, agentes: new Set(), chamadas: [] };
                        intervalos[key].agentes.add(agenteDia.nome);
                        cursor.setMinutes(cursor.getMinutes() + 10);
                    }
                });
            });

            // --- 6. Calcular Capacidade (IPAT) ---
            Object.keys(intervalos).forEach(key => {
                const dados = intervalos[key];
                const qtdAgentes = dados.agentes.size;
                const demanda = dados.recebidas;
                
                if (qtdAgentes > 0) {
                    dados.estimativaPorAgente = (demanda / qtdAgentes) * taxaOcupacao;
                } else {
                    dados.estimativaPorAgente = 0;
                }
            });

            // --- 7. Consolidar por Agente ---
            let agentesConsolidados = {};

            Object.values(agentesPorDia).forEach(registro => {
                const nome = registro.nome;
                if (!agentesConsolidados[nome]) {
                    agentesConsolidados[nome] = {
                        dias: new Set(),
                        jornadaBruta: 0,
                        jornadaLiquida: 0,
                        tempoFalado: 0,
                        pausasProd: 0,
                        pausasImprod: 0,
                        pausas10: 0, // Novo campo
                        tempoDeducao: 0,
                        chamadasAtendidas: 0,
                        chamadasEstimadasTotal: 0,
                        detalheIntervalos: {}
                    };
                }

                agentesConsolidados[nome].dias.add(registro.data.getTime());

                // Jornada
                registro.logins.sort((a,b) => a.inicio - b.inicio);
                if (registro.logins.length > 0) {
                    const primeiroLogin = registro.logins[0].inicio;
                    let ultimoLogoff = registro.logins[registro.logins.length-1].fim;
                    agentesConsolidados[nome].jornadaBruta += ((ultimoLogoff - primeiroLogin) / 1000);
                }

                // Pausas
                registro.pausas.forEach(p => {
                    let dur = (p.fim - p.inicio) / 1000;
                    if (dur < 0) dur = 0;
                    let isProd = PAUSAS_PRODUTIVAS.some(term => p.tipo.includes(term));
                    let isImprod = PAUSAS_IMPRODUTIVAS.some(term => p.tipo.includes(term));
                    let isDeducao = PAUSAS_DEDUCAO_LIQUIDA.some(term => p.tipo.includes(term));
                    let isPausa10 = PAUSAS_10.some(term => p.tipo.includes(term));

                    if (isProd) agentesConsolidados[nome].pausasProd += dur;
                    else if (isImprod) agentesConsolidados[nome].pausasImprod += dur;
                    
                    if (isDeducao) agentesConsolidados[nome].tempoDeducao += dur;
                    if (isPausa10) agentesConsolidados[nome].pausas10 += dur; // Soma Pausa 10
                });
            });

            // Cruzar chamadas e estimativas
            Object.keys(intervalos).sort().forEach(keyIntervalo => {
                const dadosInt = intervalos[keyIntervalo];
                
                dadosInt.agentes.forEach(agenteNome => {
                    if (agentesConsolidados[agenteNome]) {
                        if (!agentesConsolidados[agenteNome].detalheIntervalos[keyIntervalo]) {
                            agentesConsolidados[agenteNome].detalheIntervalos[keyIntervalo] = {
                                chamadasAtendidas: 0, tempoFalado: 0, estimativa: dadosInt.estimativaPorAgente,
                                status: 'Disponível', pausas: []
                            };
                        }
                        agentesConsolidados[agenteNome].chamadasEstimadasTotal += dadosInt.estimativaPorAgente;
                    }
                });

                dadosInt.chamadas.forEach(chamada => {
                    const nome = chamada.atendente;
                    if (agentesConsolidados[nome]) {
                        agentesConsolidados[nome].tempoFalado += chamada.duracao;
                        agentesConsolidados[nome].chamadasAtendidas += 1;
                        if (agentesConsolidados[nome].detalheIntervalos[keyIntervalo]) {
                            agentesConsolidados[nome].detalheIntervalos[keyIntervalo].chamadasAtendidas++;
                            agentesConsolidados[nome].detalheIntervalos[keyIntervalo].tempoFalado += chamada.duracao;
                            agentesConsolidados[nome].detalheIntervalos[keyIntervalo].status = 'Atendendo';
                        }
                    }
                });
            });

            // Adicionar detalhes de pausas nos intervalos
            Object.values(agentesPorDia).forEach(registro => {
                const nome = registro.nome;
                if (!agentesConsolidados[nome]) return;
                registro.pausas.forEach(p => {
                    let durPausaTotal = (p.fim - p.inicio) / 1000;
                    let cursor = new Date(p.inicio);
                    cursor.setMinutes(Math.floor(cursor.getMinutes()/10)*10, 0, 0);
                    while (cursor < p.fim) {
                        const key = getIntervalKey(cursor);
                        if (agentesConsolidados[nome].detalheIntervalos[key]) {
                            agentesConsolidados[nome].detalheIntervalos[key].status = 'Pausa (' + p.tipo + ')';
                            agentesConsolidados[nome].detalheIntervalos[key].pausas.push({
                                tipo: p.tipo, 
                                dur: durPausaTotal 
                            });
                        }
                        cursor.setMinutes(cursor.getMinutes() + 10);
                    }
                });
            });

            // --- 8. Renderizar ---
            const listaAgentes = [];
            let kpiRecebidas = chamadasFiltradas.length;
            let kpiAtendidas = 0;
            let somaOcupacao = 0;
            let somaOcioso = 0;
            let somaIpat = 0;
            let countAgentes = 0;

            Object.keys(agentesConsolidados).forEach(nome => {
                const d = agentesConsolidados[nome];
                const qtdDias = d.dias.size;
                const divisor = qtdDias > 1 ? qtdDias : 1;

                d.jornadaLiquida = d.jornadaBruta - d.tempoDeducao;
                
                // CORREÇÃO SOLICITADA:
                // Ocioso = Jornada Liquida (Jornada - Almoço - Lanche) - PausasProd - PausasImprod - Pausa10 - TempoFalado
                d.tempoOcioso = d.jornadaLiquida - d.pausasImprod - d.pausasProd - d.pausas10 - d.tempoFalado;
                
                if (d.tempoOcioso < 0) d.tempoOcioso = 0;

                d.ocupacao = (d.tempoFalado + d.pausasProd + d.pausasImprod) / (d.jornadaLiquida || 1);
                
                if (d.chamadasEstimadasTotal > 0) {
                    d.ipat = (d.chamadasAtendidas / d.chamadasEstimadasTotal) - 1;
                } else {
                    d.ipat = 0;
                }

                listaAgentes.push({
                    nome: nome,
                    dias: qtdDias,
                    jornadaLiqView: d.jornadaLiquida / divisor,
                    faladoView: d.tempoFalado / divisor,
                    prodView: d.pausasProd / divisor,
                    improdView: d.pausasImprod / divisor,
                    ociosoView: d.tempoOcioso / divisor,
                    ocupacao: d.ocupacao,
                    ipat: d.ipat,
                    // NOVAS COLUNAS
                    atendidasTotal: d.chamadasAtendidas, 
                    estimativaTotal: d.chamadasEstimadasTotal,
                    raw: d
                });

                kpiAtendidas += d.chamadasAtendidas;
                somaOcupacao += d.ocupacao;
                somaOcioso += (d.tempoOcioso / divisor);
                somaIpat += d.ipat;
                countAgentes++;
            });

            // SALVAR GLOBAL PARA USO NOS KPI CLICKS
            globalAgentesData = listaAgentes;

            // KPIs
            document.getElementById('kpiContainer').classList.remove('hidden');
            document.getElementById('kpiContainer').classList.add('grid');
            document.getElementById('kpiRecebidas').innerText = kpiRecebidas;
            document.getElementById('kpiAtendidas').innerText = kpiAtendidas;
            document.getElementById('kpiOcupacao').innerText = countAgentes ? (somaOcupacao/countAgentes * 100).toFixed(2) + '%' : '0%';
            document.getElementById('kpiOcioso').innerText = countAgentes ? secondsToTime(somaOcioso/countAgentes) : '00:00:00';
            
            const ipatMedio = countAgentes ? (somaIpat/countAgentes * 100) : 0;
            const elIpat = document.getElementById('kpiIpat');
            elIpat.innerText = ipatMedio.toFixed(2) + '%';
            elIpat.className = "text-2xl font-bold " + (ipatMedio >= 0 ? "positive" : "negative");

            // ======= RENDERIZAR GRÁFICO COMBINADO =======
            renderizarGraficoCompleto(listaAgentes);
            document.getElementById('chartContainer').classList.remove('hidden');

            // Tabela
            renderTabela(listaAgentes);
            document.getElementById('mainTableCard').classList.remove('hidden');
        }

        // --- FUNÇÃO KPI BREAKDOWN ---
        function showKpiBreakdown(metric) {
            if(!globalAgentesData || globalAgentesData.length === 0) {
                alert('Calcule os dados primeiro.');
                return;
            }

            const modal = document.getElementById('modalKPI');
            const tbody = document.getElementById('modalKpiBody');
            const headerCol = document.getElementById('kpiColHeader');
            tbody.innerHTML = '';
            
            let dataSorted = [];
            let title = "";

            if(metric === 'recebidas') {
                title = "Ranking: Capacidade de Atendimento (Estimativa)";
                headerCol.innerText = "Estimativa (Chamadas)";
                dataSorted = [...globalAgentesData].sort((a,b) => b.estimativaTotal - a.estimativaTotal);
                
                dataSorted.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${d.nome}</td><td class="text-right text-blue-600 font-bold">${d.estimativaTotal.toFixed(2)}</td>`;
                    tbody.appendChild(tr);
                });
            } else if(metric === 'atendidas') {
                title = "Ranking: Chamadas Atendidas";
                headerCol.innerText = "Qtd Atendidas";
                dataSorted = [...globalAgentesData].sort((a,b) => b.atendidasTotal - a.atendidasTotal);
                
                dataSorted.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${d.nome}</td><td class="text-right text-green-600 font-bold">${d.atendidasTotal}</td>`;
                    tbody.appendChild(tr);
                });
            } else if(metric === 'ocupacao') {
                title = "Ranking: Taxa de Ocupação";
                headerCol.innerText = "Ocupação (%)";
                dataSorted = [...globalAgentesData].sort((a,b) => b.ocupacao - a.ocupacao);
                
                dataSorted.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${d.nome}</td><td class="text-right font-bold">${(d.ocupacao*100).toFixed(2)}%</td>`;
                    tbody.appendChild(tr);
                });
            } else if(metric === 'ocioso') {
                title = "Ranking: Tempo Ocioso";
                headerCol.innerText = "Tempo Ocioso";
                dataSorted = [...globalAgentesData].sort((a,b) => b.ociosoView - a.ociosoView);
                
                dataSorted.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${d.nome}</td><td class="text-right font-bold text-orange-600">${secondsToTime(d.ociosoView)}</td>`;
                    tbody.appendChild(tr);
                });
            } else if(metric === 'ipat') {
                title = "Ranking: IPAT (Performance)";
                headerCol.innerText = "IPAT";
                dataSorted = [...globalAgentesData].sort((a,b) => b.ipat - a.ipat);
                
                dataSorted.forEach(d => {
                    const val = (d.ipat*100).toFixed(2) + '%';
                    const color = d.ipat >= 0 ? 'text-green-600' : 'text-red-600';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${d.nome}</td><td class="text-right font-bold ${color}">${val}</td>`;
                    tbody.appendChild(tr);
                });
            }

            document.getElementById('modalKpiTitle').innerText = title;
            modal.style.display = 'flex';
        }

        // --- GRÁFICO COMBINADO: BARRAS, ESTIMATIVA E TMA ---
        function renderizarGraficoCompleto(dados) {
            const dadosOrdenados = dados.sort((a,b) => a.nome.localeCompare(b.nome));
            const labels = dadosOrdenados.map(d => d.nome.split(' ')[0]);
            const dataEstimada = dadosOrdenados.map(d => d.estimativaTotal);
            const dataAtendida = dadosOrdenados.map(d => d.atendidasTotal);
            
            // Calculo TMA em Minutos
            const dataTMA = dadosOrdenados.map(d => {
                if (d.raw.chamadasAtendidas > 0) {
                    return (d.raw.tempoFalado / d.raw.chamadasAtendidas) / 60; // em minutos
                }
                return 0;
            });

            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (performanceChartInstance) performanceChartInstance.destroy();

            performanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'TMA (Minutos)',
                            data: dataTMA,
                            type: 'line',
                            borderColor: '#f59e0b', // Laranja
                            backgroundColor: '#f59e0b',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointStyle: 'circle',
                            yAxisID: 'y1', // Eixo Direito
                            order: 0
                        },
                        {
                            label: 'Estimativa (Capacidade)',
                            data: dataEstimada,
                            type: 'line',
                            borderColor: '#2563eb', // Azul
                            backgroundColor: '#2563eb',
                            borderWidth: 2,
                            pointRadius: 3,
                            fill: false,
                            tension: 0.2,
                            yAxisID: 'y', // Eixo Esquerdo
                            order: 1
                        },
                        {
                            label: 'Atendidas',
                            data: dataAtendida,
                            backgroundColor: '#10b981', // Verde
                            borderRadius: 4,
                            yAxisID: 'y', // Eixo Esquerdo
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: { display: true, text: 'Volume de Chamadas' },
                            grid: { drawOnChartArea: true }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: { display: true, text: 'TMA (Minutos)' },
                            grid: { drawOnChartArea: false }
                        },
                        x: { 
                            ticks: { maxRotation: 45, minRotation: 45 } 
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: ctx => dadosOrdenados[ctx[0].dataIndex].nome,
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    let val = context.raw;
                                    
                                    if (label.includes('TMA')) {
                                        const mins = Math.floor(val);
                                        const secs = Math.round((val - mins) * 60);
                                        return `${label}: ${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
                                    }
                                    
                                    if (typeof val === 'number') {
                                        return `${label}: ${val.toFixed(2)}`;
                                    }
                                    return `${label}: ${val}`;
                                }
                            }
                        }
                    }
                }
            });
        }


        function renderTabela(lista) {
            const tbody = document.querySelector('#tabelaAgentes tbody');
            tbody.innerHTML = '';
            
            lista.forEach(agente => {
                const tr = document.createElement('tr');
                tr.onclick = () => abrirModal(agente);
                
                const ipatPct = (agente.ipat * 100).toFixed(2) + '%';
                const ipatClass = agente.ipat >= 0 ? 'positive' : 'negative';

                tr.innerHTML = `
                    <td class="font-medium text-gray-900">${agente.nome}</td>
                    <td>${agente.dias}</td>
                    <td class="text-blue-600 font-semibold">${agente.estimativaTotal.toFixed(2)}</td>
                    <td class="text-green-600 font-semibold">${agente.atendidasTotal}</td>
                    <td>${secondsToTime(agente.jornadaLiqView)}</td>
                    <td>${secondsToTime(agente.faladoView)}</td>
                    <td>${secondsToTime(agente.prodView)}</td>
                    <td>${secondsToTime(agente.improdView)}</td>
                    <td>${secondsToTime(agente.ociosoView)}</td>
                    <td>${(agente.ocupacao * 100).toFixed(2)}%</td>
                    <td class="${ipatClass}">${ipatPct}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ==========================================
        // MODAIS
        // ==========================================
        function abrirModal(agenteData) {
            const modal = document.getElementById('modalDetalhe');
            const tbody = document.getElementById('modalBody');
            document.getElementById('modalTitle').innerText = `Detalhes: ${agenteData.nome}`;
            tbody.innerHTML = '';

            const intervalos = agenteData.raw.detalheIntervalos;
            const keys = Object.keys(intervalos).sort();
            let contagemPausas = {};

            keys.forEach(key => {
                const intData = intervalos[key];
                let descPausas = [];
                let qtdPausaDisplay = "";
                let duracaoPausaTexto = "-";

                if (intData.pausas && intData.pausas.length > 0) {
                   intData.pausas.forEach(p => {
                       let tipo = p.tipo.toLowerCase();
                       if (!contagemPausas[tipo]) contagemPausas[tipo] = 0;
                       contagemPausas[tipo]++;
                       
                       let durStr = secondsToTime(p.dur || 0);
                       descPausas.push(`${p.tipo}`);
                       duracaoPausaTexto = durStr; 

                       qtdPausaDisplay += `${p.tipo}: ${contagemPausas[tipo]} <br>`;
                   });
                }
                
                let tempoOciosoInt = 600 - intData.tempoFalado;
                if (intData.status.includes('Pausa')) tempoOciosoInt = 0; 
                if (tempoOciosoInt < 0) tempoOciosoInt = 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${key.split(' ')[1]} <span class="text-xs text-gray-400">(${key.split(' ')[0]})</span></td>
                    <td>${intData.status}</td>
                    <td>${intData.chamadasAtendidas}</td>
                    <td>${intData.estimativa.toFixed(2)}</td>
                    <td>${secondsToTime(intData.tempoFalado)}</td>
                    <td>${secondsToTime(tempoOciosoInt)}</td>
                    <td>${descPausas.join(', ')}</td>
                    <td>${duracaoPausaTexto}</td>
                    <td class="text-xs">${qtdPausaDisplay}</td>
                `;
                tbody.appendChild(tr);
            });

            modal.style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == document.getElementById('modalDetalhe')) closeModal('modalDetalhe');
            if (event.target == document.getElementById('modalKPI')) closeModal('modalKPI');
        }

        // ==========================================
        // BACKUP
        // ==========================================
        function fazerBackup() {
            const data = { chamadas: rawDataChamadas, eventos: rawDataEventos };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = "backup_ipat.json";
            a.click();
        }
        function restaurarBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                rawDataChamadas = data.chamadas || [];
                rawDataEventos = data.eventos || [];
                preencherFiltroFilas();
                alert('Restaurado com sucesso.');
            };
            reader.readAsText(file);
        }
        function limparDados() {
            if(confirm('Limpar tudo?')) {
                rawDataChamadas = []; rawDataEventos = [];
                document.getElementById('filaContainer').innerHTML = '';
                document.getElementById('kpiContainer').classList.add('hidden');
                document.getElementById('chartContainer').classList.add('hidden');
                document.getElementById('mainTableCard').classList.add('hidden');
            }
        }
    </script>
</body>
</html>