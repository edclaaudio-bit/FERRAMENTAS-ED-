<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relat√≥rio de Inconsist√™ncias (Regra 4/4) - Pontomais [Ajustado]</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f7f7f7; }
  h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
  
  /* Estilos para os controles */
  #controls { 
    margin-bottom: 20px; 
    padding: 15px; 
    border: 1px solid #ddd; 
    border-radius: 8px; 
    background-color: #fff; 
    display: flex; 
    flex-wrap: wrap; 
    gap: 20px; 
  }

  .control-group {
    display: flex;
    flex-direction: column;
    min-width: 250px;
    flex-grow: 1;
  }
  
  input[type="file"], button {
    padding: 10px 15px;
    margin-top: 5px;
    border: 1px solid;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
  }
  
  /* Estilo do bot√£o padr√£o (Gerar Relat√≥rio) */
  #gerarRelatorioBtn {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
  }
  #gerarRelatorioBtn:hover { background-color: #0056b3; }

  /* Estilo do bot√£o Exportar */
  #exportExcelBtn {
    background-color: #28a745; /* Verde */
    color: white;
    border-color: #28a745;
    margin-left: 10px;
  }
  #exportExcelBtn:hover { background-color: #1e7e34; }
  
  textarea {
    resize: vertical;
    min-height: 80px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-family: Arial, sans-serif;
  }
  
  /* Estilos da Tabela */
  #relatorio table { border-collapse: collapse; width: 100%; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0.85em; }
  #relatorio th, #relatorio td { border: 1px solid #e0e0e0; padding: 8px 4px; text-align: center; }
  #relatorio th { background-color: #e9ecef; color: #333; font-weight: bold; }
  
  /* Estilo para Inconsist√™ncia (Vermelho - Campo a Corrigir) */
  .inconsistencia { 
    background-color: #f8d7da; /* Vermelho claro */
    color: #721c24; 
    font-weight: bold; 
  }
  
  /* NOVO ESTILO: Ponto/Pausa Correto (Verde) */
  .correto {
    background-color: #d4edda; /* Verde claro */
    color: #155724; 
  }

  /* Estilo para o bot√£o de exclus√£o na linha */
  .btn-excluir {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 3px 6px;
    font-size: 0.75em;
    border-radius: 3px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .btn-excluir:hover {
    background-color: #c82333;
  }

  /* Estilo para mensagem de status */
  #statusMessage { 
    margin-top: 15px; 
    padding: 10px; 
    border-radius: 5px; 
  }
  .success { background-color: #d4edda; color: #155724; }
  .error { background-color: #f8d7da; color: #721c24; }

  /* Estilo para o rodap√© */
  footer {
    margin-top: 30px;
    padding: 10px;
    text-align: right;
    font-size: 0.8em;
    color: #777;
    border-top: 1px solid #eee;
  }
</style>
</head>
<body>
  <h2>üìä Relat√≥rio de Inconsist√™ncias de Ponto/Pausa (Pontomais)</h2>
  <p>Este relat√≥rio encontra inconsist√™ncias que **N√ÉO** possuem justificativa na coluna 'Motivo/Observa√ß√£o' e que n√£o est√£o listadas nas exce√ß√µes abaixo.</p>
  
  <div id="controls">
    <div class="control-group">
        <label for="fileInput">1. Selecione o Arquivo (XLSX, XLS ou CSV)</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv"/>
    </div>

    <div class="control-group" style="flex-grow: 2;">
        <label for="exceptionList">2. Lista de Exce√ß√£o (Nomes Completos, um por linha):</label>
        <textarea id="exceptionList" placeholder="Digite aqui os nomes dos colaboradores que devem ser ignorados no relat√≥rio. Ex: Fulano da Silva, Ciclana Souza..."></textarea>
    </div>

    <div class="control-group" style="flex-grow: 1; min-width: 150px;">
        <label>&nbsp;</label>
        <button id="gerarRelatorioBtn" onclick="gerarRelatorio()">3. Gerar Relat√≥rio</button>
    </div>

  </div>
  
  <div id="statusMessage"></div>
  <div id="relatorio"></div>
  <div id="exportControls" style="margin-top: 15px; text-align: right; display: none;">
      <button id="exportExcelBtn" onclick="exportarParaExcel()">üì• Exportar para Excel</button>
  </div>
  
  <footer>Desenvolvido por Claudio Carvalho - Vers√£o Pontomais</footer>

<script>

// =================================================================
// ‚öôÔ∏è CONFIGURA√á√ïES PRINCIPAIS (CONSTANTES)
// =================================================================

const CONFIG = {
    // O cabe√ßalho √© esperado na LINHA 4 (√≠ndice 3)
    CABECALHO_INDEX: 3, 
    
    CARGO_ALVO: 'OPERADOR DE TELEMARKETING I', // Cargo a ser filtrado
    PONTOS_ESPERADOS: 4,                      // Quantidade esperada de batidas de ponto (2 Entradas, 2 Sa√≠das)
    PAUSAS_ESPERADAS: 4,                       // Quantidade esperada de batidas de pausa (2 Pausas, 2 Retornos)
};

// =================================================================
// üó∫Ô∏è MAPA DE COLUNAS (DIN√ÇMICO)
// =================================================================

let MAPPED_COLUMNS = {
    DATA: -1,
    NOME: -1,
    CARGO: -1,
    PONTO_INICIO: -1,
    PONTO_FIM: -1,
    PAUSA_INICIO: -1,
    PAUSA_FIM: -1,
    MOTIVO_IGNORAR_S: -1, 
    MOTIVO_EXIBIR_AB: -1  
};

let GLOBAL_INCONSISTENCIES = []; // Armazena os dados para exporta√ß√£o e manipula√ß√£o
let GLOBAL_HEADER_ROW = []; // Armazena o cabe√ßalho original

// =================================================================
// üìù FUN√á√ïES AUXILIARES
// =================================================================

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = `statusMessage ${type}`;
    statusDiv.innerHTML = `<strong>${type === 'success' ? '‚úÖ Sucesso:' : '‚ùå Erro:'}</strong> ${message}`;
}

/**
 * Mapeia os √≠ndices das colunas a partir do cabe√ßalho da planilha.
 */
function mapColumns(headerRow) {
    const knownHeaders = {
        'Data': 'DATA', 
        'Nome': 'NOME', 
        'Cargo': 'CARGO',
        'Motivo para ignorar': 'MOTIVO_IGNORAR_S', 
        'Motivo/Observa√ß√£o': 'MOTIVO_EXIBIR_AB' 
    };
    
    // Reset e inicializa√ß√£o
    Object.keys(MAPPED_COLUMNS).forEach(key => MAPPED_COLUMNS[key] = -1);
    
    let isMappingPausas = false;

    headerRow.forEach((colName, index) => {
        const name = colName ? colName.toString().trim() : '';
        const lowerName = name.toLowerCase();

        // 1. Mapeia colunas de nome fixo/conhecido
        for (const [key, value] of Object.entries(knownHeaders)) {
            if (lowerName.includes(key.toLowerCase())) {
                MAPPED_COLUMNS[value] = index;
            }
        }
        
        // 2. Detecta o in√≠cio do bloco de PONTOS (Entrada/Sa√≠da)
        if (lowerName.includes('entrada') && MAPPED_COLUMNS.PONTO_INICIO === -1 && MAPPED_COLUMNS.PAUSA_INICIO === -1) {
            MAPPED_COLUMNS.PONTO_INICIO = index; 
        }

        // 3. Detecta o in√≠cio do bloco de PAUSAS (Pausa/Retorno)
        if (lowerName.includes('pausa') && MAPPED_COLUMNS.PAUSA_INICIO === -1) {
            MAPPED_COLUMNS.PAUSA_INICIO = index;
            isMappingPausas = true;
            
            // Define o fim dos Pontos como a coluna anterior ao in√≠cio das Pausas
            MAPPED_COLUMNS.PONTO_FIM = index - 1;
        }

        // 4. Continua mapeando o bloco de PAUSAS
        if (isMappingPausas) {
            if (lowerName.includes('pausa') || lowerName.includes('retorno')) {
                MAPPED_COLUMNS.PAUSA_FIM = index;
            } else if (lowerName.includes('cr√©dito') || lowerName.includes('d√©bito') || lowerName.includes('horas')) {
                isMappingPausas = false;
            }
        }
    });
    
    // Ajuste se o bloco de pausas n√£o foi detectado (caso extremo)
    if (MAPPED_COLUMNS.PAUSA_INICIO === -1 && MAPPED_COLUMNS.PONTO_INICIO !== -1) {
        // Assume que PONTO_FIM √© a √∫ltima coluna da linha, se PAUSA n√£o for encontrada
        MAPPED_COLUMNS.PONTO_FIM = headerRow.length - 1; 
    }


    if (MAPPED_COLUMNS.DATA === -1 || MAPPED_COLUMNS.NOME === -1 || MAPPED_COLUMNS.PONTO_INICIO === -1 || MAPPED_COLUMNS.PAUSA_INICIO === -1) {
        throw new Error('N√£o foi poss√≠vel identificar as colunas essenciais (Data, Nome, Ponto/Entrada, Pausa) no cabe√ßalho (Linha 4). Verifique os nomes das colunas.');
    }
}

/**
 * Processa uma √∫nica linha da planilha, aplicando todos os filtros e regras.
 */
function processRow(row, exceptionNames) {
    const map = MAPPED_COLUMNS; 
    
    // 1. FILTRO: Ignora a linha se a coluna DATA cont√©m "Colaborador" (Linha de resumo)
    if (row[map.DATA] && row[map.DATA].toString().toLowerCase().includes('colaborador')) {
        return null;
    }

    // 2. FILTRO: Ignora se a linha n√£o tem Data ou Nome
    if (!row[map.DATA] || !row[map.NOME]) return null;
    
    const nome = row[map.NOME].toString().trim();

    // 3. FILTRO: Lista de Exce√ß√£o por Nome
    if (exceptionNames.has(nome.toLowerCase())) {
        return null; 
    }

    // 4. FILTRO: Cargo Alvo
    if(map.CARGO !== -1){
        const cargo = row[map.CARGO] ? row[map.CARGO].toString().trim() : '';
        if (cargo !== CONFIG.CARGO_ALVO) return null;
    }

    // 5. FILTRO: Motivo Ignorar
    if (map.MOTIVO_IGNORAR_S !== -1) {
        const motivoS = row[map.MOTIVO_IGNORAR_S] ? row[map.MOTIVO_IGNORAR_S].toString().trim() : '';
        if (motivoS) return null;
    }

    // 6. Extrai e conta Pontos e Pausas
    const pontos = row.slice(map.PONTO_INICIO, map.PONTO_FIM + 1).filter(x => x !== undefined && x !== '' && x.toString().trim() !== '00:00');
    const pausas = row.slice(map.PAUSA_INICIO, map.PAUSA_FIM + 1).filter(x => x !== undefined && x !== '' && x.toString().trim() !== '00:00');

    // 7. Verifica Inconsist√™ncia
    const isPontoInconsistente = pontos.length !== CONFIG.PONTOS_ESPERADOS;
    const isPausaInconsistente = pausas.length !== CONFIG.PAUSAS_ESPERADAS;

    if (isPontoInconsistente || isPausaInconsistente) {
        
        // FILTRO: Verifica se a inconsist√™ncia est√° justificada na coluna Motivo/Observa√ß√£o
        let motivoAB = '';
        if (map.MOTIVO_EXIBIR_AB !== -1) {
            motivoAB = row[map.MOTIVO_EXIBIR_AB] ? row[map.MOTIVO_EXIBIR_AB].toString().trim() : '';
        }

        // Se houver inconsist√™ncia E houver justificativa, a linha √© IGNORADA.
        if (motivoAB) {
            return null; 
        }
        
        // Se a inconsist√™ncia n√£o tiver justificativa, a linha ENTRA no relat√≥rio.
        let alerta = '';
        if (isPontoInconsistente && isPausaInconsistente) {
            alerta = 'Pontos e Pausas';
        } else if (isPontoInconsistente) {
            alerta = 'Pontos';
        } else {
            alerta = 'Pausas';
        }

        return {
            id: Date.now() + Math.random(), // ID √∫nico para exclus√£o
            data: row[map.DATA],
            nome: nome,
            motivo: motivoAB || '-', 
            alerta,
            isPontoInconsistente,
            isPausaInconsistente,
            fullRow: row
        };
    }

    return null; // Linha consistente (4/4)
}

/**
 * Monta o HTML da tabela usando os dados globais.
 */
function generateTableHTML(inconsistencies, headerRow) {
    const map = MAPPED_COLUMNS;
    let html = '<table id="inconsistencyTable">'; // Adicionado ID
    
    // 1. Defini√ß√£o das colunas para exibi√ß√£o na tabela (Baseado no mapeamento)
    const colunasParaExibir = [];
    
    colunasParaExibir.push({ index: map.DATA, label: headerRow[map.DATA], type: 'data' });
    colunasParaExibir.push({ index: map.NOME, label: headerRow[map.NOME], type: 'nome' });

    // Adiciona as colunas de Ponto detectadas (Entrada/Sa√≠da)
    for(let i = map.PONTO_INICIO; i <= map.PONTO_FIM; i++) {
        colunasParaExibir.push({ index: i, label: headerRow[i], type: 'ponto' });
    }
    
    // Adiciona as colunas de Pausa detectadas (Pausa/Retorno)
    for(let i = map.PAUSA_INICIO; i <= map.PAUSA_FIM; i++) {
        colunasParaExibir.push({ index: i, label: headerRow[i], type: 'pausa' });
    }

    // Coluna de Alerta
    colunasParaExibir.push({ index: -2, label: 'Alerta', type: 'alerta' }); 
    
    // Coluna de A√ß√µes
    colunasParaExibir.push({ index: -3, label: 'A√ß√£o', type: 'acao' }); 


    // 2. Cria√ß√£o do Cabe√ßalho da Tabela
    html += '<tr>';
    colunasParaExibir.forEach(col => {
        html += `<th>${col.label}</th>`;
    });
    html += '</tr>'; 
    
    // 3. Cria√ß√£o das Linhas de Dados
    inconsistencies.forEach(r => {
        // Usa o ID √∫nico para a linha
        html += `<tr id="row-${r.id}">`; 
        
        colunasParaExibir.forEach(col => {
            let val = '';
            let classe = '';

            switch(col.type) {
                case 'data':
                    val = r.data;
                    break;
                case 'nome':
                    val = r.nome;
                    break;
                case 'ponto':
                    val = r.fullRow[col.index];
                    
                    // Se estiver inconsistente E vazio/00:00 -> VERMELHO
                    if (r.isPontoInconsistente && (!val || val.toString().trim() === '' || val.toString().trim() === '00:00')) {
                        classe = 'inconsistencia'; // Vermelho
                    } else if (val && val.toString().trim() !== '' && val.toString().trim() !== '00:00') {
                        classe = 'correto'; // Verde
                    }
                    break;
                case 'pausa':
                    val = r.fullRow[col.index];

                    // Se estiver inconsistente E vazio/00:00 -> VERMELHO
                    if (r.isPausaInconsistente && (!val || val.toString().trim() === '' || val.toString().trim() === '00:00')) {
                        classe = 'inconsistencia'; // Vermelho
                    } else if (val && val.toString().trim() !== '' && val.toString().trim() !== '00:00') {
                        classe = 'correto'; // Verde
                    }
                    break;
                case 'alerta':
                    val = r.alerta;
                    break;
                case 'acao':
                    // Bot√£o de Excluir
                    val = `<button class="btn-excluir" onclick="excluirLinha('${r.id}')">Excluir</button>`;
                    break;
            }
            
            html += `<td class="${classe}">${val}</td>`;
        });

        html += '</tr>';
    });

    html += '</table>';
    return html;
}


/**
 * Remove a linha da tabela e do array de dados global.
 */
function excluirLinha(id) {
    if (confirm("Tem certeza que deseja EXCLUIR esta linha do relat√≥rio?")) {
        // 1. Remove da DOM (Tabela)
        const row = document.getElementById(`row-${id}`);
        if (row) {
            row.remove();
        }

        // 2. Remove do array de dados global
        GLOBAL_INCONSISTENCIES = GLOBAL_INCONSISTENCIES.filter(r => r.id.toString() !== id.toString());
        
        // Atualiza a mensagem de status
        const count = GLOBAL_INCONSISTENCIES.length;
        if (count > 0) {
            showStatus(`Linha exclu√≠da com sucesso! Restam ${count} inconsist√™ncia(s) na lista.`, 'success');
        } else {
            document.getElementById('relatorio').innerHTML = '<p>üéâ N√£o restam inconsist√™ncias PENDENTES no relat√≥rio.</p>';
            document.getElementById('exportControls').style.display = 'none';
            showStatus('An√°lise conclu√≠da. Nenhuma inconsist√™ncia pendente.', 'success');
        }
    }
}


/**
 * Exporta o relat√≥rio filtrado (atual) para um arquivo Excel (XLSX).
 */
function exportarParaExcel() {
    if (GLOBAL_INCONSISTENCIES.length === 0) {
        alert('N√£o h√° dados para exportar.');
        return;
    }

    const map = MAPPED_COLUMNS; 
    const headerRow = GLOBAL_HEADER_ROW;

    // 1. Monta o cabe√ßalho final do Excel (apenas as colunas vis√≠veis no relat√≥rio)
    const finalHeader = [
        headerRow[map.DATA], 
        headerRow[map.NOME],
    ];
    // Adiciona as colunas de Ponto
    for(let i = map.PONTO_INICIO; i <= map.PONTO_FIM; i++) {
        finalHeader.push(headerRow[i]);
    }
    // Adiciona as colunas de Pausa
    for(let i = map.PAUSA_INICIO; i <= map.PAUSA_FIM; i++) {
        finalHeader.push(headerRow[i]);
    }
    finalHeader.push('Alerta');


    // 2. Monta o corpo de dados
    const finalData = GLOBAL_INCONSISTENCIES.map(item => {
        const row = [
            item.data,
            item.nome
        ];
        // Adiciona valores de Ponto
        for(let i = map.PONTO_INICIO; i <= map.PONTO_FIM; i++) {
            row.push(item.fullRow[i]);
        }
        // Adiciona valores de Pausa
        for(let i = map.PAUSA_INICIO; i <= map.PAUSA_FIM; i++) {
            row.push(item.fullRow[i]);
        }
        row.push(item.alerta);
        return row;
    });

    const dataForExport = [finalHeader, ...finalData];
    
    // 3. Cria o Workbook e Sheet
    const ws = XLSX.utils.aoa_to_sheet(dataForExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inconsistencias");

    // 4. Exporta o arquivo
    const fileName = `Relatorio_Inconsistencias_Pontomais_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.xlsx`;
    XLSX.writeFile(wb, fileName);

    showStatus('Exporta√ß√£o conclu√≠da! O arquivo Excel foi baixado.', 'success');
}


// =================================================================
// ‚ö° FUN√á√ÉO PRINCIPAL
// =================================================================

function gerarRelatorio() {
    document.getElementById('relatorio').innerHTML = '';
    document.getElementById('exportControls').style.display = 'none';
    const fileInput = document.getElementById('fileInput');
    const exceptionListInput = document.getElementById('exceptionList').value;
    
    if(!fileInput.files.length) { 
        showStatus('Selecione um arquivo .xlsx, .xls ou .csv para continuar.', 'error');
        return; 
    }

    showStatus('Analisando o arquivo... Por favor, aguarde.', 'success');
    
    // Processa a lista de exce√ß√µes
    const exceptionNames = new Set(
        exceptionListInput.split('\n')
            .map(name => name.trim().toLowerCase())
            .filter(name => name.length > 0)
    );
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const ws = workbook.Sheets[workbook.SheetNames[0]]; 
            const json = XLSX.utils.sheet_to_json(ws, {header:1, defval: ''}); 

            if(json.length < CONFIG.CABECALHO_INDEX + 1) { 
                showStatus('O arquivo n√£o cont√©m dados suficientes.', 'error');
                return;
            }

            // 1. Mapeamento
            GLOBAL_HEADER_ROW = json[CONFIG.CABECALHO_INDEX];
            mapColumns(GLOBAL_HEADER_ROW); 

            const inconsistencies = [];
            
            // 2. Processamento dos Dados
            for(let i = 0; i < json.length; i++){
                const row = json[i];
                // Passa a lista de exce√ß√µes para a fun√ß√£o de processamento
                const result = processRow(row, exceptionNames);

                if (result) {
                    inconsistencies.push(result);
                }
            }
            
            // 3. Gera√ß√£o do Relat√≥rio
            GLOBAL_INCONSISTENCIES = inconsistencies; // Atualiza dados globais

            if(GLOBAL_INCONSISTENCIES.length === 0){
                 document.getElementById('relatorio').innerHTML = '<p>üéâ N√£o foram encontradas inconsist√™ncias PENDENTES (Ap√≥s filtros e lista de exce√ß√µes).</p>';
                 showStatus('An√°lise conclu√≠da. Nenhuma inconsist√™ncia pendente.', 'success');
                 document.getElementById('exportControls').style.display = 'none';
                 return;
            }

            const relHTML = generateTableHTML(GLOBAL_INCONSISTENCIES, GLOBAL_HEADER_ROW);
            document.getElementById('relatorio').innerHTML = relHTML;
            document.getElementById('exportControls').style.display = 'block'; // Mostra bot√£o de exportar
            showStatus(`Relat√≥rio gerado com sucesso! ${GLOBAL_INCONSISTENCIES.length} inconsist√™ncia(s) N√ÉO JUSTIFICADA(S) encontrada(s).`, 'success');

        } catch (error) {
            console.error("Erro ao processar o arquivo:", error);
            showStatus(`Erro ao processar o arquivo. Detalhes: ${error.message}`, 'error');
        }
    };
    
    reader.onerror = function() {
        showStatus('Erro ao ler o arquivo. Tente novamente.', 'error');
    };

    reader.readAsArrayBuffer(fileInput.files[0]);
}
</script>
</body>
</html>