<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel de Ajustes | Pontomais</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #4f46e5; --primary-hover: #4338ca;
    --success-bg: #dcfce7; --success-text: #166534;
    --danger-bg: #fee2e2; --danger-text: #991b1b;
    --bg: #f3f4f6; --card: #ffffff;
    --text-main: #1f2937; --text-sub: #6b7280;
    --border: #e5e7eb;
  }

  body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }
  .container { max-width: 1400px; margin: 0 auto; }
  
  header { margin-bottom: 25px; text-align: center; }
  h2 { margin: 0; font-weight: 700; letter-spacing: -0.025em; }
  
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .stat-card { background: var(--card); padding: 15px 20px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid var(--border); }
  .stat-card span { display: block; font-size: 0.75rem; text-transform: uppercase; color: var(--text-sub); font-weight: 700; margin-bottom: 5px; }
  .stat-card strong { font-size: 1.25rem; color: var(--primary); }

  .main-card { background: var(--card); border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 25px; }
  .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  
  label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 8px; }
  input[type="file"], textarea, input[type="text"] {
    width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; box-sizing: border-box;
  }

  .btn {
    padding: 12px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
    transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  }
  .btn-primary { background: var(--primary); color: white; width: 100%; font-size: 1rem; }
  .btn-primary:hover { background: var(--primary-hover); }
  .btn-success { background: #059669; color: white; }
  .btn-danger { background: var(--danger-text); color: white; padding: 6px 12px; font-size: 0.75rem; }

  /* Tabela Estilizada */
  .table-container { background: var(--card); border-radius: 12px; overflow-x: auto; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 1000px; }
  th { background: #f9fafb; padding: 12px 15px; text-align: center; border-bottom: 2px solid var(--border); color: var(--text-sub); font-weight: 600; }
  td { padding: 10px 15px; border-bottom: 1px solid var(--border); text-align: center; }
  
  /* Badges de Ponto */
  .ponto-cell { border-radius: 6px; font-weight: 600; padding: 6px; display: block; margin: 2px; }
  .missing { background: var(--danger-bg); color: var(--danger-text); border: 1px dashed #f87171; }
  .correct { background: var(--success-bg); color: var(--success-text); }
  
  .search-bar { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
  .search-bar input { flex-grow: 1; }

  footer { margin-top: 40px; text-align: center; font-size: 0.8rem; color: var(--text-sub); padding-bottom: 20px; border-top: 1px solid var(--border); padding-top: 20px; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h2>üïì Ajustes | Ponto Mais</h2>
    <p style="color: var(--text-sub)">Identifica√ß√£o visual de batidas ausentes (4 pontos e 4 pausas)</p>
  </header>

  <div class="stats-grid">
    <div class="stat-card"><span>Total Registros</span><strong id="stat-total">0</strong></div>
    <div class="stat-card"><span>Inconsist√™ncias</span><strong id="stat-errors" style="color: var(--danger-text)">0</strong></div>
    <div class="stat-card"><span>Filtro de Cargo</span><strong id="stat-cargo" style="font-size: 0.85em;">Aguardando...</strong></div>
  </div>

  <div class="main-card">
    <div class="grid-inputs">
      <div class="control-group">
        <label>Cargo Alvo (Exato)</label>
        <input type="text" id="targetJob" value="OPERADOR DE TELEMARKETING I">
        <label style="margin-top:15px">Arquivo do Pontomais</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
      </div>
      <div class="control-group">
        <label>Exce√ß√µes (Nomes por linha)</label>
        <textarea id="exceptionList" rows="5" placeholder="Cole aqui os nomes que deseja ignorar..."></textarea>
      </div>
    </div>
    <button class="btn btn-primary" onclick="gerarRelatorio()">üîç Analisar Inconsist√™ncias</button>
  </div>

  <div id="resultArea" style="display: none;">
    <div class="search-bar">
        <input type="text" id="tableSearch" onkeyup="filterTable()" placeholder="Pesquisar por nome do colaborador...">
        <button class="btn btn-success" onclick="exportarParaExcel()">üì• Exportar Planilha de Ajustes</button>
    </div>
    
    <div class="table-container">
      <div id="relatorio"></div>
    </div>
  </div>

  <footer>Desenvolvido por Claudio Carvalho
</div>

<script>
const CONFIG = { CABECALHO_INDEX: 3, PONTOS_ESPERADOS: 4, PAUSAS_ESPERADAS: 4 };
let MAPPED_COLUMNS = { DATA: -1, NOME: -1, CARGO: -1, P_INI: -1, P_FIM: -1, PAU_INI: -1, PAU_FIM: -1, MOT_IGN: -1, MOT_OBS: -1 };
let GLOBAL_DATA = [];
let GLOBAL_HEADER = [];

function mapColumns(headerRow) {
    const searchMap = { 'Data': 'DATA', 'Nome': 'NOME', 'Cargo': 'CARGO', 'Motivo para ignorar': 'MOT_IGN', 'Motivo/Observa√ß√£o': 'MOT_OBS' };
    Object.keys(MAPPED_COLUMNS).forEach(k => MAPPED_COLUMNS[k] = -1);
    
    let pausasIniciadas = false;
    headerRow.forEach((name, i) => {
        const n = name?.toString().toLowerCase() || '';
        for (const [key, val] of Object.entries(searchMap)) {
            if (n.includes(key.toLowerCase())) MAPPED_COLUMNS[val] = i;
        }
        if (n.includes('entrada') && MAPPED_COLUMNS.P_INI === -1) MAPPED_COLUMNS.P_INI = i;
        if (n.includes('pausa') && MAPPED_COLUMNS.PAU_INI === -1) {
            MAPPED_COLUMNS.PAU_INI = i;
            MAPPED_COLUMNS.P_FIM = i - 1;
            pausasIniciadas = true;
        }
        if (pausasIniciadas && (n.includes('pausa') || n.includes('retorno'))) MAPPED_COLUMNS.PAU_FIM = i;
    });
}

function gerarRelatorio() {
    const file = document.getElementById('fileInput').files[0];
    const targetJob = document.getElementById('targetJob').value.trim();
    if (!file) return alert("Por favor, selecione o arquivo XLSX primeiro.");

    const exceptions = new Set(document.getElementById('exceptionList').value.split('\n').map(n => n.trim().toLowerCase()).filter(n => n));
    const reader = new FileReader();

    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {header:1, defval: ''});

        GLOBAL_HEADER = json[CONFIG.CABECALHO_INDEX];
        mapColumns(GLOBAL_HEADER);
        GLOBAL_DATA = [];

        json.forEach((row, idx) => {
            if (idx <= CONFIG.CABECALHO_INDEX || !row[MAPPED_COLUMNS.DATA] || row[MAPPED_COLUMNS.DATA].toString().includes('Colaborador')) return;
            
            const nome = row[MAPPED_COLUMNS.NOME]?.toString().trim();
            const cargo = row[MAPPED_COLUMNS.CARGO]?.toString().trim();
            const motIgn = row[MAPPED_COLUMNS.MOT_IGN]?.toString().trim();
            const motObs = row[MAPPED_COLUMNS.MOT_OBS]?.toString().trim();

            if (exceptions.has(nome.toLowerCase()) || (targetJob && cargo !== targetJob) || motIgn || motObs) return;

            const ptsRange = row.slice(MAPPED_COLUMNS.P_INI, MAPPED_COLUMNS.P_FIM + 1);
            const pasRange = row.slice(MAPPED_COLUMNS.PAU_INI, MAPPED_COLUMNS.PAU_FIM + 1);
            
            const ptsValidos = ptsRange.filter(v => v && v !== '00:00');
            const pasValidos = pasRange.filter(v => v && v !== '00:00');

            if (ptsValidos.length !== CONFIG.PONTOS_ESPERADOS || pasValidos.length !== CONFIG.PAUSAS_ESPERADAS) {
                GLOBAL_DATA.push({
                    id: Math.random().toString(36).substr(2, 9),
                    data: row[MAPPED_COLUMNS.DATA],
                    nome,
                    pontos: ptsRange,
                    pausas: pasRange,
                    full: row
                });
            }
        });

        renderTable();
        document.getElementById('stat-total').innerText = json.length - 4;
        document.getElementById('stat-errors').innerText = GLOBAL_DATA.length;
        document.getElementById('stat-cargo').innerText = targetJob || "Todos";
        document.getElementById('resultArea').style.display = 'block';
    };
    reader.readAsArrayBuffer(file);
}

function renderTable() {
    let html = `<table id="inconsistencyTable"><thead><tr>
        <th>Data</th><th>Colaborador</th>`;
    
    // Cabe√ßalhos Din√¢micos de Batida
    for(let i = MAPPED_COLUMNS.P_INI; i <= MAPPED_COLUMNS.P_FIM; i++) html += `<th>${GLOBAL_HEADER[i]}</th>`;
    for(let i = MAPPED_COLUMNS.PAU_INI; i <= MAPPED_COLUMNS.PAU_FIM; i++) html += `<th>${GLOBAL_HEADER[i]}</th>`;
    
    html += `<th>A√ß√£o</th></tr></thead><tbody>`;

    GLOBAL_DATA.forEach(r => {
        html += `<tr id="row-${r.id}">
            <td>${r.data}</td>
            <td style="text-align:left"><strong>${r.nome}</strong></td>`;
        
        // Renderiza c√©lulas de ponto
        r.pontos.forEach(v => {
            const isMissing = !v || v === '00:00';
            html += `<td><span class="ponto-cell ${isMissing ? 'missing' : 'correct'}">${isMissing ? 'VAZIO' : v}</span></td>`;
        });

        // Renderiza c√©lulas de pausa
        r.pausas.forEach(v => {
            const isMissing = !v || v === '00:00';
            html += `<td><span class="ponto-cell ${isMissing ? 'missing' : 'correct'}">${isMissing ? 'VAZIO' : v}</span></td>`;
        });

        html += `<td><button class="btn btn-danger" onclick="excluirLinha('${r.id}')">Remover</button></td></tr>`;
    });
    
    html += `</tbody></table>`;
    document.getElementById('relatorio').innerHTML = html;
}

function filterTable() {
    const input = document.getElementById("tableSearch").value.toUpperCase();
    const trs = document.querySelectorAll("#inconsistencyTable tbody tr");
    trs.forEach(tr => {
        tr.style.display = tr.textContent.toUpperCase().includes(input) ? "" : "none";
    });
}

function excluirLinha(id) {
    GLOBAL_DATA = GLOBAL_DATA.filter(r => r.id !== id);
    document.getElementById(`row-${id}`).remove();
    document.getElementById('stat-errors').innerText = GLOBAL_DATA.length;
}

function exportarParaExcel() {
    if(!GLOBAL_DATA.length) return;
    const exportRows = GLOBAL_DATA.map(r => {
        const obj = { "Data": r.data, "Colaborador": r.nome };
        r.pontos.forEach((v, i) => obj[GLOBAL_HEADER[MAPPED_COLUMNS.P_INI + i]] = v || "FALTANTE");
        r.pausas.forEach((v, i) => obj[GLOBAL_HEADER[MAPPED_COLUMNS.PAU_INI + i]] = v || "FALTANTE");
        return obj;
    });
    const ws = XLSX.utils.json_to_sheet(exportRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ajustes");
    XLSX.writeFile(wb, `Ajustes_Ponto_${new Date().toLocaleDateString().replace(/\//g,'-')}.xlsx`);
}
</script>
</body>
</html>



