<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Pro v9 | Almo√ßo Separado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --primary: #4f46e5;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); padding: 20px; }
        .container { max-width: 1350px; margin: 0 auto; }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 15px; display: flex; justify-content: space-between; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
        .field label { font-size: 11px; font-weight: 600; color: var(--text-main); }
        input { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; outline: none; }
        input:focus { border-color: var(--primary); }

        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-export { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-import { background: #f8fafc; border: 1px solid var(--primary); color: var(--primary); }

        .table-wrap { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px; font-size: 10px; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); text-align: left; }
        td { padding: 8px 12px; font-size: 13px; border-bottom: 1px solid var(--border); }
        
        .status-pill { padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 10px; cursor: help; position: relative; display: inline-block; }
        .status-ok { background: #ecfdf5; color: #065f46; }
        .status-alert { background: #fef2f2; color: #991b1b; }

        .scroll-box { max-height: 450px; overflow-y: auto; border: 1px solid var(--border); border-radius: 12px; background: white; }
        .stats-badge { background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 99px; font-size: 10px; }
        .hidden-input { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="card-title">
            <span>‚öôÔ∏è Gest√£o de Escala</span>
            <span id="totalCallsInfo" class="stats-badge">Aguardando CSV Intelix...</span>
        </div>
        <div class="dashboard-grid">
            <div class="field-group">
                <div class="field"><label>Abertura da Opera√ß√£o</label><input type="time" id="opOpen" value="07:00" onchange="salvarConfig()"></div>
                <div class="field"><label>Fechamento da Opera√ß√£o</label><input type="time" id="opClose" value="19:00" onchange="salvarConfig()"></div>
            </div>
            <div class="field-group">
                <div class="field"><label>TMA da Equipe (hh:mm:ss)</label><input type="text" id="tmaInput" value="00:05:00" onchange="salvarConfig()"></div>
                <div class="field"><label>Relat√≥rio Intelix (Detalhamento de Chamadas)</label><input type="file" id="csvFile" accept=".csv" onchange="processarCSV()"></div>
            </div>
            <div class="field-group">
                <div class="field"><label>Quantidade de Atendentes (6h20 | 7h12)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="qtd6h" value="2" style="width:50%" onchange="salvarConfig()">
                        <input type="number" id="qtd7h" value="8" style="width:50%" onchange="salvarConfig()">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="gerarEscalaMestra()" style="width:100%">GERAR NOVA ESCALA</button>
            </div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-export" onclick="exportarPNG()">üñºÔ∏è Salvar Imagem</button>
        <button class="btn btn-export" onclick="exportarExcel()">üìä Exportar Escala (CSV)</button>
        <label class="btn btn-import">
            üì• Importar Escala Salva
            <input type="file" class="hidden-input" id="importEscala" accept=".csv" onchange="importarEscala(this)">
        </label>
        <button class="btn btn-export" onclick="limparMemoria()" style="color: var(--danger)">üóëÔ∏è Limpar Tudo</button>
    </div>

    <div class="section-header" style="margin-bottom:10px; font-weight:800;">üìÖ Escala de Atendentes</div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Atendente</th><th>Jornada</th><th>Entrada</th><th>Pausa 1</th><th>Sa√≠da Almo√ßo</th><th>Retorno Almo√ßo</th><th>Pausa 2</th><th>Sa√≠da</th>
                </tr>
            </thead>
            <tbody id="corpoEscala"></tbody>
        </table>
    </div>

    <div class="section-header" style="margin-bottom:10px; font-weight:800;">üìä Dimensionamento Detalhado</div>
    <div class="scroll-box">
        <table>
            <thead style="position: sticky; top: 0; z-index: 10; background: white;">
                <tr>
                    <th>Janela</th><th>Chamadas</th><th>Logados</th><th>Necess√°rio</th><th>Status</th>
                </tr>
            </thead>
            <tbody id="corpoCobertura"></tbody>
        </table>
    </div>
</div>

<script>
    let mapaTrafego = {}; 
    let operadores = [];
    let diasUnicos = 1;

    // --- MEM√ìRIA ---
    window.onload = () => {
        const savedOps = localStorage.getItem('operadores_v9');
        const savedConfig = localStorage.getItem('configEscala_v9');
        if (savedConfig) {
            const cfg = JSON.parse(savedConfig);
            document.getElementById('opOpen').value = cfg.opOpen;
            document.getElementById('opClose').value = cfg.opClose;
            document.getElementById('tmaInput').value = cfg.tmaInput;
            document.getElementById('qtd6h').value = cfg.qtd6h;
            document.getElementById('qtd7h').value = cfg.qtd7h;
        }
        if (savedOps) {
            operadores = JSON.parse(savedOps);
            renderizar();
        }
    };

    function salvarConfig() {
        const config = {
            opOpen: document.getElementById('opOpen').value,
            opClose: document.getElementById('opClose').value,
            tmaInput: document.getElementById('tmaInput').value,
            qtd6h: document.getElementById('qtd6h').value,
            qtd7h: document.getElementById('qtd7h').value
        };
        localStorage.setItem('configEscala_v9', JSON.stringify(config));
    }

    function limparMemoria() {
        if(confirm("Deseja apagar todos os dados salvos?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- TEMPO ---
    function hmsToSeg(hms) {
        const a = hms.split(':');
        return (+a[0]) * 3600 + (+a[1]) * 60 + (a[2] ? +a[2] : 0);
    }

    function timeToMin(t) {
        if(!t || !t.includes(':')) return 0;
        const parts = t.replace(/\s*\(\d+\)/g, '').trim().split(':');
        return (parseInt(parts[0]) * 60) + parseInt(parts[1]);
    }

    function minToTime(m) {
        m = (m + 1440) % 1440;
        return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
    }

    // --- PROCESSAMENTO ---
    function processarCSV() {
        const file = document.getElementById('csvFile').files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split('\n');
            const acumulado = {};
            const dias = new Set();
            let totalLidas = 0;
            for (let i = 0; i < lines.length; i++) {
                const col = lines[i].split(';');
                if (col.length < 10) continue;
                const dataRaw = col[3]?.replace(/"/g, '').trim();
                const horaRaw = col[9]?.replace(/"/g, '').trim();
                if (dataRaw && horaRaw && horaRaw.includes(':')) {
                    dias.add(dataRaw);
                    const min = timeToMin(horaRaw);
                    acumulado[min] = (acumulado[min] || 0) + 1;
                    totalLidas++;
                }
            }
            diasUnicos = dias.size || 1;
            mapaTrafego = {};
            for (let m in acumulado) mapaTrafego[m] = acumulado[m] / diasUnicos;
            document.getElementById('totalCallsInfo').innerText = `üìä ${totalLidas} chamadas | ${diasUnicos} dia(s)`;
            recalculaAnalise();
        };
        reader.readAsText(file, 'ISO-8859-1');
    }

    function gerarEscalaMestra() {
        const open = timeToMin(document.getElementById('opOpen').value);
        const close = timeToMin(document.getElementById('opClose').value);
        const q6 = parseInt(document.getElementById('qtd6h').value) || 0;
        const q7 = parseInt(document.getElementById('qtd7h').value) || 0;
        const total = q6 + q7;

        if (total === 0) return alert("Defina o headcount.");

        operadores = [];
        for (let i = 0; i < total; i++) {
            const tipo = i < q6 ? '06:20' : '07:12';
            const duracao = tipo === '06:20' ? 380 : 492;
            const dAlm = tipo === '06:20' ? 20 : 60;
            let start = open + (i * (close - duracao - open) / (total - 1 || 1));

            operadores.push({
                id: Date.now() + i, 
                nome: `Atendente ${i+1}`, 
                tipo, 
                in: Math.round(start),
                p1: Math.round(start + 90), 
                almIn: Math.round(start + 180), 
                almOut: Math.round(start + 180 + dAlm),
                p2: Math.round(start + 300), 
                out: Math.round(start + duracao)
            });
        }
        renderizar();
        salvarConfig();
    }

    function renderizar() {
        let htmlEscala = '';
        operadores.sort((a,b) => a.in - b.in).forEach(op => {
            htmlEscala += `<tr>
                <td contenteditable="true" onblur="sync(${op.id}, 'nome', this.innerText)"><b>${op.nome}</b></td>
                <td>${op.tipo}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'in', this.innerText)">${minToTime(op.in)}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'p1', this.innerText)">${minToTime(op.p1)}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'almIn', this.innerText)">${minToTime(op.almIn)}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'almOut', this.innerText)">${minToTime(op.almOut)}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'p2', this.innerText)">${minToTime(op.p2)}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'out', this.innerText)">${minToTime(op.out)}</td>
            </tr>`;
        });
        document.getElementById('corpoEscala').innerHTML = htmlEscala;
        localStorage.setItem('operadores_v9', JSON.stringify(operadores));
        recalculaAnalise();
    }

    function sync(id, key, val) { 
        let o = operadores.find(x => x.id === id); 
        o[key] = val; 
        localStorage.setItem('operadores_v9', JSON.stringify(operadores));
        recalculaAnalise(); 
    }

    function syncTime(id, key, val) { 
        let o = operadores.find(x => x.id === id); 
        o[key] = timeToMin(val); 
        renderizar(); 
    }

    function recalculaAnalise() {
        const tmaSeg = hmsToSeg(document.getElementById('tmaInput').value) || 300;
        const open = timeToMin(document.getElementById('opOpen').value);
        const close = timeToMin(document.getElementById('opClose').value);
        let htmlCobertura = '';
        for (let h = open; h < close; h += 10) {
            let prev10 = 0;
            for(let m = h; m < h + 10; m++) prev10 += (mapaTrafego[m] || 0);
            let equipeNec = Math.ceil((prev10 * tmaSeg) / 600);
            let logados = operadores.filter(op => {
                const emTurno = h >= op.in && h < op.out;
                const emP1 = h >= op.p1 && h < op.p1 + 10;
                const emAlm = h >= op.almIn && h < op.almOut;
                const emP2 = h >= op.p2 && h < op.p2 + 10;
                return emTurno && !emP1 && !emAlm && !emP2;
            }).length;
            let gap = logados < equipeNec;
            htmlCobertura += `<tr style="${logados === 0 && equipeNec > 0 ? 'background:#fff1f2' : ''}">
                <td>${minToTime(h)} - ${minToTime(h+10)}</td>
                <td>${prev10.toFixed(1)}</td>
                <td style="${gap ? 'color:var(--danger); font-weight:800;' : ''}">${logados}</td>
                <td><b>${equipeNec}</b></td>
                <td><span class="status-pill ${gap ? 'status-alert' : 'status-ok'}" data-reason="Nec: ${equipeNec} | Log: ${logados}">${gap ? 'GAP' : 'OK'}</span></td>
            </tr>`;
        }
        document.getElementById('corpoCobertura').innerHTML = htmlCobertura;
    }

    function exportarExcel() {
        let csv = "\uFEFFAtendente;Jornada;Entrada;Pausa 1;Saida Almoco;Retorno Almoco;Pausa 2;Saida\n";
        operadores.forEach(o => { 
            csv += `${o.nome};${o.tipo};${minToTime(o.in)};${minToTime(o.p1)};${minToTime(o.almIn)};${minToTime(o.almOut)};${minToTime(o.p2)};${minToTime(o.out)}\n`; 
        });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8' }));
        link.download = `Escala_Completa.csv`;
        link.click();
    }

    function importarEscala(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split('\n');
            const novos = [];
            for (let i = 1; i < lines.length; i++) {
                const col = lines[i].split(';');
                if (col.length < 8) continue;
                novos.push({
                    id: Date.now() + i, nome: col[0], tipo: col[1], in: timeToMin(col[2]),
                    p1: timeToMin(col[3]), almIn: timeToMin(col[4]), almOut: timeToMin(col[5]),
                    p2: timeToMin(col[6]), out: timeToMin(col[7])
                });
            }
            if(novos.length > 0) { operadores = novos; renderizar(); }
        };
        reader.readAsText(file, 'UTF-8');
    }

    function exportarPNG() {
        html2canvas(document.body).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Dashboard_Escala.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>
</body>
</html>
