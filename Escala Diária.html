<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Pro v8 | Leitura Inteligente</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --primary: #4f46e5;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); padding: 20px; }
        .container { max-width: 1250px; margin: 0 auto; }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 15px; display: flex; justify-content: space-between; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
        .field label { font-size: 11px; font-weight: 600; color: var(--text-main); }
        input { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; outline: none; }
        input:focus { border-color: var(--primary); ring: 2px solid #4f46e522; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-export { background: white; border: 1px solid var(--border); color: var(--text-main); }

        .table-wrap { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px; font-size: 10px; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); text-align: left; }
        td { padding: 8px 12px; font-size: 13px; border-bottom: 1px solid var(--border); }
        
        .status-pill { padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 10px; cursor: help; position: relative; display: inline-block; }
        .status-ok { background: #ecfdf5; color: #065f46; }
        .status-alert { background: #fef2f2; color: #991b1b; }

        .status-pill:hover::after {
            content: attr(data-reason);
            position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 8px 12px; border-radius: 6px;
            font-size: 11px; white-space: nowrap; z-index: 100;
        }

        .scroll-box { max-height: 450px; overflow-y: auto; border: 1px solid var(--border); border-radius: 12px; background: white; }
        .stats-badge { background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 99px; font-size: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="card-title">
            <span>‚öôÔ∏è Par√¢metros de Alta Precis√£o</span>
            <span id="totalCallsInfo" class="stats-badge">Aguardando CSV...</span>
        </div>
        <div class="dashboard-grid">
            <div class="field-group">
                <div class="field"><label>Abertura da Opera√ß√£o</label><input type="time" id="opOpen" value="07:00"></div>
                <div class="field"><label>Fechamento da Opera√ß√£o</label><input type="time" id="opClose" value="19:00"></div>
            </div>
            <div class="field-group">
                <div class="field"><label>TMA (hh:mm:ss)</label><input type="text" id="tmaInput" value="00:05:00"></div>
                <div class="field"><label>Relat√≥rio Intelix (Detalhamento)</label><input type="file" id="csvFile" accept=".csv" onchange="processarCSV()"></div>
            </div>
            <div class="field-group">
                <div class="field"><label>Equipe (6h20 | 7h12)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="qtd6h" value="2" style="width:50%">
                        <input type="number" id="qtd7h" value="8" style="width:50%">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="gerarEscalaMestra()">PROCESSAR DIMENSIONAMENTO</button>
            </div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-export" onclick="exportarPNG()">üñºÔ∏è Salvar Imagem</button>
        <button class="btn btn-export" onclick="exportarExcel()">üìä Exportar CSV</button>
    </div>

    <div class="section-header" style="margin-bottom:10px; font-weight:800;">üìÖ Escala de Atendentes</div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Atendente</th><th>Jornada</th><th>Entrada</th><th>Pausa 1</th><th>Almo√ßo</th><th>Pausa 2</th><th>Sa√≠da</th>
                </tr>
            </thead>
            <tbody id="corpoEscala"></tbody>
        </table>
    </div>

    <div class="section-header" style="margin-bottom:10px; font-weight:800;">üìä Dimensionamento Detalhado (10 em 10 min)</div>
    <div class="scroll-box">
        <table>
            <thead style="position: sticky; top: 0; z-index: 10; background: white;">
                <tr>
                    <th>Janela de Tempo</th><th>Chamadas</th><th>Logados</th><th>Equipe Necess√°ria</th><th>Status</th>
                </tr>
            </thead>
            <tbody id="corpoCobertura"></tbody>
        </table>
    </div>
</div>

<script>
    let mapaTrafego = {}; 
    let operadores = [];
    let diasUnicos = 1;

    function hmsToSeg(hms) {
        const a = hms.split(':');
        return (+a[0]) * 3600 + (+a[1]) * 60 + (a[2] ? +a[2] : 0);
    }

    // Fun√ß√£o melhorada para limpar a hora do Intelix (remove o "(1)" ou "(2)")
    function cleanIntelixTime(timeStr) {
        if(!timeStr) return "";
        return timeStr.replace(/\s*\(\d+\)/g, '').trim();
    }

    function timeToMin(t) {
        if(!t) return 0;
        let clean = cleanIntelixTime(t);
        const parts = clean.split(':');
        return parts.length >= 2 ? (parseInt(parts[0]) * 60) + parseInt(parts[1]) : 0;
    }

    function minToTime(m) {
        m = (m + 1440) % 1440;
        return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
    }

    function processarCSV() {
        const file = document.getElementById('csvFile').files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split('\n');
            const acumulado = {};
            const dias = new Set();
            let totalLidas = 0;
            
            // Localiza em qual coluna est√° a "data" e a "horaEntradaPos"
            let colData = 3;
            let colHora = 9;

            for (let i = 0; i < lines.length; i++) {
                const col = lines[i].split(';');
                if (col.length < 10) continue;

                // Tenta validar se a linha √© de dados (Data no formato YYYY-MM-DD ou DD/MM/YYYY)
                const dataRaw = col[colData]?.replace(/"/g, '').trim();
                const horaRaw = col[colHora]?.replace(/"/g, '').trim();

                if (dataRaw && horaRaw && horaRaw.includes(':')) {
                    dias.add(dataRaw);
                    const min = timeToMin(horaRaw);
                    acumulado[min] = (acumulado[min] || 0) + 1;
                    totalLidas++;
                }
            }
            
            diasUnicos = dias.size || 1;
            mapaTrafego = {};
            // Normaliza pela quantidade de dias no relat√≥rio
            for (let m in acumulado) {
                mapaTrafego[m] = acumulado[m] / diasUnicos;
            }

            document.getElementById('totalCallsInfo').innerText = `üìä ${totalLidas} chamadas identificadas em ${diasUnicos} dia(s)`;
            alert(`Leitura conclu√≠da!\nTotal de chamadas: ${totalLidas}\nM√©dia por dia: ${(totalLidas/diasUnicos).toFixed(1)}`);
            if(operadores.length > 0) recalculaAnalise();
        };
        reader.readAsText(file, 'ISO-8859-1');
    }

    function gerarEscalaMestra() {
        const open = timeToMin(document.getElementById('opOpen').value);
        const close = timeToMin(document.getElementById('opClose').value);
        const q6 = parseInt(document.getElementById('qtd6h').value) || 0;
        const q7 = parseInt(document.getElementById('qtd7h').value) || 0;
        const total = q6 + q7;

        if (total === 0) return alert("Defina o headcount.");

        operadores = [];
        for (let i = 0; i < total; i++) {
            const tipo = i < q6 ? '06:20' : '07:12';
            const duracao = tipo === '06:20' ? 380 : 492;
            const dAlm = tipo === '06:20' ? 20 : 60;

            let start;
            if (i === 0) start = open;
            else if (i === total - 1) start = close - duracao;
            else start = open + (i * (close - duracao - open) / (total - 1));

            operadores.push({
                id: i, nome: `Atendente ${i+1}`, tipo, in: Math.round(start),
                p1: Math.round(start + 90), alm: Math.round(start + 180), dAlm: dAlm,
                p2: Math.round(start + 300), out: Math.round(start + duracao)
            });
        }
        renderizar();
    }

    function renderizar() {
        let htmlEscala = '';
        operadores.sort((a,b) => a.in - b.in).forEach(op => {
            htmlEscala += `<tr>
                <td contenteditable="true" onblur="sync(${op.id}, 'nome', this.innerText)"><b>${op.nome}</b></td>
                <td>${op.tipo}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'in', this.innerText)">${minToTime(op.in)}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'p1', this.innerText)">${minToTime(op.p1)}</td>
                <td contenteditable="true" onblur="syncAlm(${op.id}, this.innerText)">${minToTime(op.alm)} - ${minToTime(op.alm+op.dAlm)}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'p2', this.innerText)">${minToTime(op.p2)}</td>
                <td contenteditable="true" onblur="syncTime(${op.id}, 'out', this.innerText)">${minToTime(op.out)}</td>
            </tr>`;
        });
        document.getElementById('corpoEscala').innerHTML = htmlEscala;
        recalculaAnalise();
    }

    function sync(id, key, val) { 
        let o = operadores.find(x => x.id === id); 
        o[key] = val; 
        recalculaAnalise(); 
    }

    function syncTime(id, key, val) { 
        let o = operadores.find(x => x.id === id); 
        o[key] = timeToMin(val); 
        renderizar(); 
    }

    function syncAlm(id, val) { 
        let o = operadores.find(x => x.id === id); 
        const h = val.split('-')[0].trim();
        o.alm = timeToMin(h); 
        renderizar(); 
    }

    function recalculaAnalise() {
        const tmaSeg = hmsToSeg(document.getElementById('tmaInput').value) || 300;
        const open = timeToMin(document.getElementById('opOpen').value);
        const close = timeToMin(document.getElementById('opClose').value);
        let htmlCobertura = '';

        for (let h = open; h < close; h += 10) {
            let prev10 = 0;
            for(let m = h; m < h + 10; m++) prev10 += (mapaTrafego[m] || 0);
            
            let equipeNec = Math.ceil((prev10 * tmaSeg) / 600);

            let logados = operadores.filter(op => {
                const emTurno = h >= op.in && h < op.out;
                const emP1 = h >= op.p1 && h < op.p1 + 10;
                const emAlm = h >= op.alm && h < op.alm + op.dAlm;
                const emP2 = h >= op.p2 && h < op.p2 + 10;
                return emTurno && !emP1 && !emAlm && !emP2;
            }).length;

            let gap = logados < equipeNec;
            let status = gap ? (logados === 0 ? 'SEM COBERTURA' : 'GAP') : 'OK';
            let reason = gap ? `Necess√°rio: ${equipeNec} | Logados: ${logados}. Faltam ${equipeNec - logados} pessoas.` : 'Equipe suficiente.';

            htmlCobertura += `<tr style="${logados === 0 && equipeNec > 0 ? 'background:#fff1f2' : ''}">
                <td>${minToTime(h)} - ${minToTime(h+10)}</td>
                <td>${prev10.toFixed(1)}</td>
                <td style="${gap ? 'color:var(--danger); font-weight:800;' : ''}">${logados}</td>
                <td><b>${equipeNec}</b></td>
                <td><span class="status-pill ${gap ? 'status-alert' : 'status-ok'}" data-reason="${reason}">${status}</span></td>
            </tr>`;
        }
        document.getElementById('corpoCobertura').innerHTML = htmlCobertura;
    }

    function exportarExcel() {
        let csv = "\uFEFFAtendente;Entrada;Saida\n";
        operadores.forEach(o => { csv += `${o.nome};${minToTime(o.in)};${minToTime(o.out)}\n`; });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        link.download = 'Planejamento_Escala.csv';
        link.click();
    }

    function exportarPNG() {
        html2canvas(document.body).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Dashboard_Escala.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>
</body>
</html>
