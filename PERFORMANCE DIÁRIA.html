<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Performance Di√°ria Simplificada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Define a fonte Inter como padr√£o */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estiliza√ß√£o para o cont√™iner de upload para melhor apar√™ncia */
        .upload-area {
            border: 2px dashed #3b82f6;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            background-color: #eff6ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background-color: #dbeafe;
        }
        /* Estilo para a tabela de resultados */
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #1f2937;
            color: #ffffff;
            font-weight: 600;
            text-transform: uppercase;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .info-card {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-6 lg:p-10">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-2">
            üìä Acompanhamento de Performance Di√°ria
        </h1>

        <div id="upload-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">1. Carregar Dados CSV</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="upload-area">
                    <label for="file-chamadas" class="block text-lg font-medium text-blue-600 mb-1">Detalhamento de Chamadas</label>
                    <input type="file" id="file-chamadas" accept=".csv" class="hidden">
                    <p id="label-chamadas" class="text-sm text-gray-500 mt-2">Nenhum arquivo selecionado.</p>
                </div>
                <div class="upload-area">
                    <label for="file-eventos" class="block text-lg font-medium text-blue-600 mb-1">Eventos de Atendentes</label>
                    <input type="file" id="file-eventos" accept=".csv" class="hidden">
                    <p id="label-eventos" class="text-sm text-gray-500 mt-2">Nenhum arquivo selecionado.</p>
                </div>
                <div class="upload-area">
                    <label for="file-csat" class="block text-lg font-medium text-blue-600 mb-1">Pesquisa de Satisfa√ß√£o (CSAT)</label>
                    <input type="file" id="file-csat" accept=".csv" class="hidden">
                    <p id="label-csat" class="text-sm text-gray-500 mt-2">Nenhum arquivo selecionado.</p>
                </div>
            </div>
            
            <button id="process-button" 
                    class="mt-6 w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50"
                    disabled>
                Processar e Calcular Desempenho Di√°rio
            </button>
        </div>
        
        <div id="message-area" class="mt-4 hidden p-4 rounded-lg text-center font-medium bg-red-100 text-red-700"></div>

        <div id="results-section" class="hidden">
            
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">2. Relat√≥rio e Filtros</h2>

                <div class="flex flex-wrap items-end gap-6 mb-6">
                    
                    <div class="flex-grow">
                        <label for="collaborator-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Colaborador:</label>
                        <select id="collaborator-filter" class="w-full md:w-64 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">Todos os Colaboradores</option>
                            </select>
                    </div>

                    <div>
                        <button id="export-button" 
                                class="py-2.5 px-6 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-300">
                            Exportar para Excel (CSV)
                        </button>
                    </div>
                </div>

                <div class="mb-8 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Evolu√ß√£o Di√°ria da Performance</h3>
                    <div class="relative h-96">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table id="daily-results-table" class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th>Dia</th>
                                <th>Colaborador</th>
                                <th>Total Chamadas</th>
                                <th>TMA</th>
                                <th>Total Pesquisas</th>
                                <th>Prod. Pesquisas (%)</th> 
                                <th>% Promotores (4-5)</th>
                                <th>% Neutros (3)</th>
                                <th>% Detratores (1-2)</th>
                                <th>P. Registro</th>
                                <th>P. Digital</th>
                                <th>P. √Ågua</th>
                                <th>P. Banheiro</th>
                                </tr>
                        </thead>
                        <tbody id="results-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    
    <footer class="mt-12 py-4 border-t border-gray-300 text-center text-gray-600">
        <p class="text-sm">Desenvolvido por **Claudio Carvalho** | &copy; 2025</p>
    </footer>

    <script>
        const DELIMITER_CSV = ';'; 
        
        let processedDailyData = {};
        let collaboratorList = [];
        let performanceChart = null; // Vari√°vel para a inst√¢ncia do Chart.js
        
        // --- UTILS DE CONVERS√ÉO E VALIDA√á√ÉO ---

        /**
         * Converte tempo no formato HH:MM:SS para segundos.
         * @param {string} timeStr - Tempo formatado (HH:MM:SS).
         * @returns {number} Tempo total em segundos.
         */
        const timeToSeconds = (timeStr) => {
            if (!timeStr || typeof timeStr !== 'string') return 0;
            
            // Remove par√™nteses com n√∫meros e espa√ßos extras (ex: "17:43:33 (1)")
            const cleanTimeStr = timeStr.replace(/\s*\([^)]*\)/g, '').trim();

            const parts = cleanTimeStr.split(':');
            if (parts.length === 3) {
                // HH:MM:SS
                const h = parseInt(parts[0], 10) || 0;
                const m = parseInt(parts[1], 10) || 0;
                const s = parseInt(parts[2], 10) || 0;
                return h * 3600 + m * 60 + s;
            }
            return 0;
        };
        
        /**
         * Tenta analisar uma linha CSV.
         */
        const parseLine = (line) => {
            // Tenta primeiro o delimitador ponto e v√≠rgula
            let parts = line.split(DELIMITER_CSV);
            if (parts.length > 1) return parts.map(p => p.trim());
            
            // Se n√£o funcionar, tenta a v√≠rgula
            parts = line.split(',');
            if (parts.length > 1) return parts.map(p => p.trim());
            
            return [line];
        };

        /**
         * Tenta analisar a data/hora e extrai o dia (YYYY-MM-DD) e hora (HH:MM:SS).
         * @returns {Object|null} {isoDate: 'YYYY-MM-DD', brDate: 'DD/MM/YYYY', time: 'HH:MM:SS'}
         */
        const extractDateTimeInfo = (dateTimeStr) => {
            if (!dateTimeStr) return null;

            let date;
            const cleanStr = dateTimeStr.trim().replace(/"/g, ''); 
            
            // Tenta formato YYYY/MM/DD (como na coluna 'data' do eventosAtendentes)
            if (cleanStr.match(/^\d{4}\/\d{2}\/\d{2}/)) {
                // Cria a data no fuso hor√°rio local para evitar problemas de deslocamento de dia.
                const parts = cleanStr.split(' ')[0].split('/');
                if (parts.length === 3) {
                    date = new Date(`${parts[0]}-${parts[1]}-${parts[2]}T00:00:00`);
                }
            } 
            // Tenta Formato YYYY-MM-DD (detalhamentoChamadas.csv, satisfacaoclientes.csv)
            else if (cleanStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                date = new Date(cleanStr.replace(' ', 'T'));
            }
            // Tenta formato DD/MM/YYYY (Brasileiro)
            else {
                const brMatch = cleanStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                if (brMatch) {
                    date = new Date(`${brMatch[3]}-${brMatch[2]}-${brMatch[1]}T00:00:00`);
                }
            }

            if (date && !isNaN(date.getTime())) {
                // Para ordena√ß√£o correta, usamos a data no formato Date object (timestamp)
                const isoDate = date.toISOString().split('T')[0];
                const timestamp = date.getTime(); 
                
                // Formata a data para DD/MM/YYYY
                const brDate = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
                
                let time = '';
                const timeMatch = cleanStr.match(/(\d{2}):(\d{2}):(\d{2})/);
                if (timeMatch) {
                    time = timeMatch[0];
                }

                return { isoDate, brDate, time, timestamp };
            }
            return null;
        };
        
        /**
         * Converte segundos para o formato HH:MM:SS.
         */
        const formatSeconds = (seconds) => {
            if (isNaN(seconds) || seconds < 0) return '00:00:00';
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(Math.floor(seconds % 60) % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        };
        
        /**
         * Encontra o valor da coluna, tratando varia√ß√µes de casing e nomes.
         */
        const findColumnValue = (row, possibleKeys) => {
            const rowKeys = Object.keys(row);
            for (const expectedKey of possibleKeys) {
                if (row[expectedKey]) {
                    return row[expectedKey];
                }
                const normalizedExpectedKey = expectedKey.toLowerCase().trim();
                for (const actualKey of rowKeys) {
                    if (actualKey.toLowerCase().trim() === normalizedExpectedKey) {
                        return row[actualKey];
                    }
                }
            }
            return null;
        };
        
        // --- MANUSEIO DE ARQUIVOS E INTERFACE ---

        const fileInputs = [
            'file-chamadas', 
            'file-eventos', 
            'file-csat'
        ];

        const updateProcessButtonState = () => {
            const allFilesSelected = fileInputs.every(id => document.getElementById(id).files.length > 0);
            document.getElementById('process-button').disabled = !allFilesSelected;
        };

        fileInputs.forEach(id => {
            const input = document.getElementById(id);
            const label = document.getElementById(`label-${id.split('-')[1]}`);
            const area = input.parentElement;

            area.addEventListener('click', () => input.click());

            input.addEventListener('change', () => {
                if (input.files.length > 0) {
                    label.textContent = `Arquivo carregado: ${input.files[0].name}`;
                    area.classList.remove('bg-red-100', 'border-red-500', 'bg-eff6ff', 'border-blue-600');
                    area.classList.add('bg-green-100', 'border-green-500');
                } else {
                    label.textContent = 'Nenhum arquivo selecionado.';
                    area.classList.remove('bg-green-100', 'border-green-500');
                    area.classList.add('bg-eff6ff', 'border-blue-600');
                }
                updateProcessButtonState();
            });
        });

        /**
         * L√™ e analisa o conte√∫do de um arquivo CSV.
         */
        const parseCSV = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        
                        // Localiza o cabe√ßalho
                        let headerIndex = -1;
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].toLowerCase();
                            // Crit√©rio de cabe√ßalho: deve ter 'data' e algum termo espec√≠fico
                            if (line.includes('data') && (line.includes('atendente') || line.includes('uniqueid') || line.includes('nota') || line.includes('evento') || line.includes('pergunta_1'))) {
                                headerIndex = i;
                                break;
                            }
                        }

                        if (headerIndex === -1) {
                            reject(new Error(`N√£o foi poss√≠vel identificar o cabe√ßalho no arquivo ${file.name}.`));
                            return;
                        }

                        const headers = parseLine(lines[headerIndex]).map(h => h.trim().replace(/"/g, ''));
                        const data = [];
                        for (let i = headerIndex + 1; i < lines.length; i++) {
                            const values = parseLine(lines[i]);
                            // Verifica se a linha tem um n√∫mero razo√°vel de colunas (pelo menos metade do cabe√ßalho)
                            if (values.length < headers.length * 0.5) continue; 
                            
                            const row = {};
                            headers.forEach((header, index) => {
                                // Remove aspas duplas de todos os valores e espa√ßos extras
                                row[header] = values[index] ? values[index].replace(/"/g, '').trim() : ''; 
                            });
                            data.push(row);
                        }
                        resolve(data);
                    } catch (error) {
                        reject(new Error(`Erro ao processar o arquivo CSV ${file.name}: ${error.message}`));
                    }
                };
                // Usa 'iso-8859-1' ou 'latin1' para tratar a maioria dos CSVs com acentos (padr√£o brasileiro)
                reader.onerror = (e) => reject(new Error(`Erro ao ler o arquivo ${file.name}.`));
                reader.readAsText(file, 'iso-8859-1'); 
            });
        };


        /**
         * Processa os 3 arquivos e calcula as m√©tricas di√°rias por colaborador.
         */
        const processFiles = async () => {
            document.getElementById('message-area').classList.add('hidden');
            document.getElementById('process-button').disabled = true;
            document.getElementById('process-button').textContent = 'Processando... Aguarde.';

            const files = {
                chamadas: document.getElementById('file-chamadas').files[0],
                eventos: document.getElementById('file-eventos').files[0],
                csat: document.getElementById('file-csat').files[0],
            };

            try {
                const [chamadasData, eventosData, csatData] = await Promise.all([
                    parseCSV(files.chamadas),
                    parseCSV(files.eventos),
                    parseCSV(files.csat),
                ]);

                // Objeto para armazenar m√©tricas agrupadas por Colaborador|Dia
                const dailyMetrics = {}; 
                const uniqueCollaborators = new Set();
                
                const initializeDailyMetric = (key, colaborador) => {
                    if (!dailyMetrics[key]) {
                        dailyMetrics[key] = {
                            colaborador: colaborador,
                            brDate: '', // Data em DD/MM/YYYY
                            timestamp: 0, // Novo campo para ordena√ß√£o
                            
                            // M√©tricas de Chamadas
                            chamadasAtendidas: 0,
                            tempoAtendimentoTotal: 0, 
                            
                            // M√©tricas de Satisfa√ß√£o (CSAT)
                            pesquisasRealizadas: 0,
                            promotersCount: 0, 
                            neutralsCount: 0,  
                            detractorsCount: 0, 
                            
                            // M√©tricas de Pausas
                            tempoRegistroTotal: 0, // TMR
                            pausaDigitalTotal: 0,
                            pausaAguaTotal: 0,
                            pausaBanheiroTotal: 0,
                        };
                    }
                };
                
                // Mapeamento de Pausas (Foco em pausas essenciais)
                const PAUSA_MAP = {
                    'P√ìS-ATENDIMENTO': 'tempoRegistroTotal',
                    'REGISTRO': 'tempoRegistroTotal',
                    'REGISTRO DE CHAMADA': 'tempoRegistroTotal',
                    'CANAL DIGITAL': 'pausaDigitalTotal',
                    'AGUA': 'pausaAguaTotal',
                    'BANHEIRO': 'pausaBanheiroTotal',
                };


                // 1. PROCESSAR CHAMADAS (Total Chamadas, Tempo Atendimento - TMA)
                chamadasData.forEach(row => {
                    const dataInfo = extractDateTimeInfo(findColumnValue(row, ['data', 'Data', 'data/hora in√≠cio']));
                    const colaborador = findColumnValue(row, ['nomeAtendente', 'NomeAtendente', 'atendente']);
                    const tempoAtendimentoStr = findColumnValue(row, ['tempoAtendimento', 'TempoAtendimento', 'duracao atendimento']); 
                    
                    if (dataInfo && colaborador) {
                        const { isoDate, brDate, timestamp } = dataInfo;
                        const key = `${colaborador}|${isoDate}`;
                        uniqueCollaborators.add(colaborador);
                        initializeDailyMetric(key, colaborador);
                        
                        dailyMetrics[key].brDate = brDate;
                        dailyMetrics[key].timestamp = timestamp;

                        const duracaoSegundos = timeToSeconds(tempoAtendimentoStr);
                        if (duracaoSegundos > 0) { 
                             dailyMetrics[key].chamadasAtendidas++;
                        }
                        dailyMetrics[key].tempoAtendimentoTotal += duracaoSegundos;
                    }
                });
                
                // 2. PROCESSAR EVENTOS (Pauses)
                eventosData.forEach(row => {
                    // Nota: Usamos a coluna 'data' para agrupar o dia
                    const dataInfo = extractDateTimeInfo(findColumnValue(row, ['data', 'dataInicio', 'DataInicio'])); 
                    const colaborador = findColumnValue(row, ['nomeAtendente', 'NomeAtendente', 'atendente']);
                    const evento = findColumnValue(row, ['evento', 'Evento'])?.trim().toUpperCase(); 
                    const nomePausa = findColumnValue(row, ['nomePausa', 'Nome Pausa', 'Pausa'])?.trim().toUpperCase();
                    const duracaoStr = findColumnValue(row, ['duracao', 'Duracao', 'dura√ß√£o']); 
                    
                    if (dataInfo && colaborador) {
                        const { isoDate, brDate, timestamp } = dataInfo;
                        const key = `${colaborador}|${isoDate}`;
                        uniqueCollaborators.add(colaborador);
                        initializeDailyMetric(key, colaborador);

                        dailyMetrics[key].brDate = brDate;
                        dailyMetrics[key].timestamp = timestamp;
                        const duracaoSegundos = timeToSeconds(duracaoStr);
                        
                        // 2.1 PAUSAS E REGISTRO
                        if (duracaoSegundos > 0) {
                            const eventToMap = nomePausa || evento;
                            let metricKey = null;

                            // Tenta mapear o Nome da Pausa/Evento
                            for (const [pausaName, keyName] of Object.entries(PAUSA_MAP)) {
                                if (eventToMap.includes(pausaName)) {
                                    metricKey = keyName;
                                    break;
                                }
                            }
                            
                            // Se for evento de REGISTRO (P√≥s-Atendimento, Registro, etc.)
                            if (!metricKey && ['P√ìS-ATENDIMENTO', 'REGISTRO DE CHAMADA', 'REGISTRO'].includes(evento)) {
                                metricKey = 'tempoRegistroTotal';
                            }
                            
                            if (metricKey) {
                                dailyMetrics[key][metricKey] += duracaoSegundos;
                            }
                        }
                    }
                });

                // 3. PROCESSAR CSAT (Total Pesquisas, Promotores, Neutros, Detratores)
                csatData.forEach(row => {
                    const dataInfo = extractDateTimeInfo(findColumnValue(row, ['data', 'data pesquisa', 'Data Pesquisa']));
                    const colaborador = findColumnValue(row, ['nomeAtendente', 'NomeAtendente', 'atendente']);
                    const notaStr = findColumnValue(row, ['Pergunta_1', 'Nota Atendente', 'Nota', 'pergunta_1']); 
                    const nota = parseInt(notaStr, 10); 
                    
                    if (dataInfo && colaborador && !isNaN(nota) && nota >= 1 && nota <= 5) {
                        const { isoDate, brDate, timestamp } = dataInfo;
                        const key = `${colaborador}|${isoDate}`;
                        uniqueCollaborators.add(colaborador);
                        initializeDailyMetric(key, colaborador);

                        dailyMetrics[key].brDate = brDate;
                        dailyMetrics[key].timestamp = timestamp;
                        dailyMetrics[key].pesquisasRealizadas++;
                        
                        // Classifica√ß√£o CSAT Detalhada (Nota 1 a 5)
                        if (nota >= 4) { // Promotores: Notas 4 e 5
                            dailyMetrics[key].promotersCount++;
                        } else if (nota === 3) { // Neutros: Nota 3
                            dailyMetrics[key].neutralsCount++;
                        } else { // Detratores: Notas 1 e 2
                            dailyMetrics[key].detractorsCount++;
                        }
                    }
                });

                // 4. CALCULAR M√âTRICAS FINAIS E FORMATAR
                const finalResults = [];
                Object.entries(dailyMetrics).forEach(([key, metrics]) => {
                    
                    const tmaSeconds = metrics.chamadasAtendidas > 0 
                        ? (metrics.tempoAtendimentoTotal / metrics.chamadasAtendidas)
                        : 0;

                    const totalPesquisas = metrics.pesquisasRealizadas;
                    const totalChamadas = metrics.chamadasAtendidas;
                    
                    // C√ÅLCULO DA NOVA M√âTRICA: Produtividade Pesquisas (%)
                    const percentPesquisas = (totalChamadas > 0 && totalPesquisas > 0)
                        ? (totalPesquisas / totalChamadas) * 100
                        : 0;
                    
                    // C√°lculo das porcentagens de satisfa√ß√£o detalhada
                    const percentPromotores = totalPesquisas > 0 
                        ? (metrics.promotersCount / totalPesquisas) * 100 
                        : 0;
                        
                    const percentNeutros = totalPesquisas > 0 
                        ? (metrics.neutralsCount / totalPesquisas) * 100 
                        : 0;
                        
                    const percentDetratores = totalPesquisas > 0
                        ? (metrics.detractorsCount / totalPesquisas) * 100
                        : 0;
                        
                    finalResults.push({
                        dia: metrics.brDate, // Usando DD/MM/YYYY
                        timestamp: metrics.timestamp, // Para ordena√ß√£o
                        colaborador: metrics.colaborador,
                        
                        // M√©tricas do Gr√°fico
                        totalChamadas: totalChamadas,
                        tma: formatSeconds(Math.round(tmaSeconds)), // TMA formatado
                        tmaSeconds: Math.round(tmaSeconds), // TMA em segundos (para o gr√°fico)

                        // M√©tricas de Satisfa√ß√£o
                        totalPesquisas: totalPesquisas,
                        percentPesquisas: percentPesquisas.toFixed(1), 
                        percentPromotores: percentPromotores.toFixed(1),
                        percentNeutros: percentNeutros.toFixed(1),
                        percentDetratores: percentDetratores.toFixed(1),
                        
                        // Pausas Detalhadas
                        pausaRegistro: formatSeconds(metrics.tempoRegistroTotal),
                        pausaDigital: formatSeconds(metrics.pausaDigitalTotal),
                        pausaAgua: formatSeconds(metrics.pausaAguaTotal),
                        pausaBanheiro: formatSeconds(metrics.pausaBanheiroTotal),
                        totalPausasSeconds: metrics.tempoRegistroTotal + metrics.pausaDigitalTotal + metrics.pausaAguaTotal + metrics.pausaBanheiroTotal, // Total Pausas em segundos (para o gr√°fico)
                    });
                });
                
                // Filtra apenas dados relevantes (com chamadas ou pesquisas) e ordena
                processedDailyData = finalResults.filter(item => item.totalChamadas > 0 || item.totalPesquisas > 0).sort((a, b) => {
                    // Ordena primeiro por Colaborador
                    if (a.colaborador < b.colaborador) return -1;
                    if (a.colaborador > b.colaborador) return 1;
                    
                    // Depois pela data (timestamp)
                    return a.timestamp - b.timestamp;
                });
                collaboratorList = Array.from(uniqueCollaborators).sort();
                
                // Atualiza a UI
                populateCollaboratorFilter();
                filterResults(); // Chama filterResults para renderizar tabela e gr√°fico

                document.getElementById('results-section').classList.remove('hidden');
                document.getElementById('message-area').classList.add('hidden');
                document.getElementById('process-button').textContent = 'Processamento Conclu√≠do!';
                document.getElementById('process-button').disabled = false;


            } catch (error) {
                console.error("Erro no processamento:", error);
                const messageArea = document.getElementById('message-area');
                messageArea.textContent = `Erro no processamento: ${error.message}. Verifique se os arquivos est√£o corretos e as colunas chaves ('data', 'nomeAtendente', 'tempoAtendimento', 'duracao', 'Pergunta_1', 'evento') existem.`;
                messageArea.classList.remove('hidden');
                messageArea.classList.add('bg-red-100', 'text-red-700');
                
                document.getElementById('process-button').textContent = 'Processar e Calcular Desempenho Di√°rio';
                document.getElementById('process-button').disabled = false;
            }
        };

        // --- MANUSEIO DE FILTROS, TABELA E GR√ÅFICO ---

        const populateCollaboratorFilter = () => {
            const select = document.getElementById('collaborator-filter');
            select.innerHTML = '<option value="all">Opera√ß√£o Total</option>'; // Reset e renomeado

            if (collaboratorList.length > 0) {
                collaboratorList.forEach(colaborador => {
                    const option = document.createElement('option');
                    option.value = colaborador;
                    option.textContent = colaborador;
                    select.appendChild(option);
                });
            } else {
                 const option = document.createElement('option');
                 option.value = 'none';
                 option.textContent = 'Nenhum Colaborador Encontrado';
                 select.appendChild(option);
            }
            
            select.removeEventListener('change', filterResults);
            select.addEventListener('change', filterResults);
        };

        const filterResults = () => {
            const selectedCollaborator = document.getElementById('collaborator-filter').value;
            let filteredData = processedDailyData;

            if (selectedCollaborator !== 'all' && selectedCollaborator !== 'none') {
                filteredData = processedDailyData.filter(item => item.colaborador === selectedCollaborator);
            }
            
            // Se for Opera√ß√£o Total, precisa agrupar por dia
            if (selectedCollaborator === 'all') {
                filteredData = aggregateDataByDay(filteredData);
            } else {
                 // Garantir ordena√ß√£o por data para o gr√°fico do indiv√≠duo
                 filteredData = filteredData.sort((a, b) => a.timestamp - b.timestamp);
            }

            renderTable(filteredData);
            renderChart(filteredData, selectedCollaborator);
        };
        
        /**
         * Agrupa dados de todos os colaboradores por dia.
         */
        const aggregateDataByDay = (data) => {
            const dailyAggregation = {};

            data.forEach(item => {
                if (!dailyAggregation[item.dia]) {
                    dailyAggregation[item.dia] = {
                        dia: item.dia,
                        timestamp: item.timestamp,
                        colaborador: 'OPERA√á√ÉO TOTAL',
                        totalChamadas: 0,
                        tempoAtendimentoTotal: 0,
                        pesquisasRealizadas: 0,
                        promotersCount: 0,
                        neutralsCount: 0,
                        detractorsCount: 0,
                        totalPausasSeconds: 0,
                        // Pausas Detalhadas para a Tabela (Manteremos como soma total para a Opera√ß√£o)
                        pausaRegistroTotal: 0, 
                        pausaDigitalTotal: 0,
                        pausaAguaTotal: 0,
                        pausaBanheiroTotal: 0,
                    };
                }
                
                dailyAggregation[item.dia].totalChamadas += item.totalChamadas;
                dailyAggregation[item.dia].tempoAtendimentoTotal += (item.totalChamadas * item.tmaSeconds); // Converte TMA de volta para tempo total
                dailyAggregation[item.dia].pesquisasRealizadas += item.totalPesquisas;
                // Os counts de CSAT n√£o est√£o no item final, ent√£o faremos uma aproxima√ß√£o:
                // Reconstruir os counts a partir dos percentuais √© impreciso.
                // Como n√£o temos os counts brutos no processedDailyData, vamos pular a agrega√ß√£o de CSAT e Pausas detalhadas na Tabela para a "Opera√ß√£o Total" por simplicidade.
                
                // M√©trica de tempo de atendimento para o total
                dailyAggregation[item.dia].totalPausasSeconds += item.totalPausasSeconds;
            });
            
            // Recalcula TMA e % CSAT
            const aggregatedResults = Object.values(dailyAggregation).map(agg => {
                 const tmaSeconds = agg.totalChamadas > 0 ? agg.tempoAtendimentoTotal / agg.totalChamadas : 0;
                 
                 // Nota: Sem os counts brutos, o % CSAT e a Produtividade de Pesquisas ser√£o imprecisas na agrega√ß√£o.
                 // Para simplificar a exibi√ß√£o no gr√°fico de OPERA√á√ÉO TOTAL, usaremos a m√©dia do TMA em segundos e o Total de Chamadas.
                 
                 return {
                     dia: agg.dia,
                     timestamp: agg.timestamp,
                     colaborador: agg.colaborador,
                     totalChamadas: agg.totalChamadas,
                     tma: formatSeconds(Math.round(tmaSeconds)),
                     tmaSeconds: Math.round(tmaSeconds),
                     totalPesquisas: agg.pesquisasRealizadas,
                     // Colunas de %CSAT e %Prod. Pesquisas ficar√£o zeradas/vazias na tabela agregada
                     percentPesquisas: 'N/A', 
                     percentPromotores: 'N/A',
                     percentNeutros: 'N/A',
                     percentDetratores: 'N/A',
                     pausaRegistro: formatSeconds(agg.pausaRegistroTotal),
                     pausaDigital: formatSeconds(agg.pausaDigitalTotal),
                     pausaAgua: formatSeconds(agg.pausaAguaTotal),
                     pausaBanheiro: formatSeconds(agg.pausaBanheiroTotal),
                     totalPausasSeconds: agg.totalPausasSeconds,
                 };
            }).sort((a, b) => a.timestamp - b.timestamp);
            
            return aggregatedResults;
        };


        const renderTable = (data) => {
            const tbody = document.getElementById('results-body');
            tbody.innerHTML = ''; // Limpa a tabela

            const numColumns = 13; 
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${numColumns}" class="text-center py-4 text-gray-500">Nenhum dado di√°rio encontrado para o filtro.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const row = tbody.insertRow();
                
                // L√≥gica de formata√ß√£o condicional (s√≥ funciona se n√£o for N/A)
                let detratorClass = 'text-gray-600';
                if (item.percentDetratores !== 'N/A') {
                    const detPercent = parseFloat(item.percentDetratores);
                    if (detPercent <= 5.0) { 
                        detratorClass = 'text-green-600';
                    } else if (detPercent <= 10.0) { 
                        detratorClass = 'text-yellow-600';
                    } else {
                        detratorClass = 'text-red-600';
                    }
                }
                
                const prodPesqClass = item.percentPesquisas !== 'N/A' && parseFloat(item.percentPesquisas) >= 50 ? 'text-blue-600 font-semibold' : 'text-gray-600';

                // Pausas detalhadas s√≥ s√£o √∫teis no filtro individual. Para Total, mostramos apenas o TMA e Total Chamadas.
                const pausaRegValue = item.colaborador === 'OPERA√á√ÉO TOTAL' ? 'N/A' : item.pausaRegistro;
                const pausaDigValue = item.colaborador === 'OPERA√á√ÉO TOTAL' ? 'N/A' : item.pausaDigital;
                const pausaAguaValue = item.colaborador === 'OPERA√á√ÉO TOTAL' ? 'N/A' : item.pausaAgua;
                const pausaBanheiroValue = item.colaborador === 'OPERA√á√ÉO TOTAL' ? 'N/A' : item.pausaBanheiro;
                
                // TMA da Opera√ß√£o Total vem em segundos e j√° foi re-formatado
                const tmaValue = item.tma; 


                row.innerHTML = `
                    <td>${item.dia}</td>
                    <td>${item.colaborador}</td>
                    <td>${item.totalChamadas}</td>
                    <td>${tmaValue}</td>
                    <td>${item.totalPesquisas}</td>
                    <td class="${prodPesqClass}">${item.percentPesquisas} ${item.percentPesquisas !== 'N/A' ? '%' : ''}</td> 
                    <td class="font-semibold text-green-600">${item.percentPromotores} ${item.percentPromotores !== 'N/A' ? '%' : ''}</td>
                    <td class="font-semibold text-yellow-600">${item.percentNeutros} ${item.percentNeutros !== 'N/A' ? '%' : ''}</td>
                    <td class="font-semibold ${detratorClass}">${item.percentDetratores} ${item.percentDetratores !== 'N/A' ? '%' : ''}</td>
                    <td>${pausaRegValue}</td>
                    <td>${pausaDigValue}</td>
                    <td>${pausaAguaValue}</td>
                    <td>${pausaBanheiroValue}</td>
                `;
            });
        };
        
        /**
         * Renderiza o gr√°fico de linha de evolu√ß√£o.
         */
        const renderChart = (data, selectedCollaborator) => {
            const chartCanvas = document.getElementById('performanceChart');
            
            // Destr√≥i a inst√¢ncia anterior do gr√°fico, se existir
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            if (data.length === 0) {
                 chartCanvas.getContext('2d').clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                 return;
            }

            const labels = data.map(item => item.dia);
            
            // Dados para o eixo Y (TMA e Pausas em Segundos, CSAT em %)
            const tmaData = data.map(item => item.tmaSeconds);
            const csatData = data.map(item => parseFloat(item.percentPromotores || 0)); // % Promotores como principal CSAT
            const totalPausasData = data.map(item => item.totalPausasSeconds / 60); // Pausas em Minutos para visualiza√ß√£o
            
            const isIndividual = selectedCollaborator !== 'all';

            const titleText = isIndividual 
                ? `Evolu√ß√£o Di√°ria - ${data[0].colaborador}` 
                : 'Evolu√ß√£o Di√°ria - Opera√ß√£o Total (Agregado)';


            performanceChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Chamadas (Unid.)',
                            data: data.map(item => item.totalChamadas),
                            borderColor: 'rgb(59, 130, 246)', // Tailwind blue-500
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: false,
                            yAxisID: 'y1', // Eixo √† direita
                            tension: 0.1,
                        },
                        {
                            label: isIndividual ? 'TMA (Segundos)' : 'TMA M√©dio (Segundos)',
                            data: tmaData,
                            borderColor: 'rgb(249, 115, 22)', // Tailwind orange-600
                            backgroundColor: 'rgba(249, 115, 22, 0.2)',
                            fill: false,
                            yAxisID: 'y2', // Eixo √† esquerda
                            tension: 0.1,
                            hidden: false,
                        },
                        {
                            label: isIndividual ? '% Promotores (CSAT)' : 'N/A na Opera√ß√£o Total',
                            data: csatData,
                            borderColor: 'rgb(22, 163, 74)', // Tailwind green-600
                            backgroundColor: 'rgba(22, 163, 74, 0.2)',
                            fill: false,
                            yAxisID: 'y3', // Eixo √† direita
                            tension: 0.1,
                            hidden: !isIndividual, // Esconde se for Opera√ß√£o Total (sem agrega√ß√£o de % CSAT)
                        },
                        {
                            label: isIndividual ? 'Pausas (Minutos)' : 'Total Pausas (Minutos)',
                            data: totalPausasData,
                            borderColor: 'rgb(124, 58, 237)', // Tailwind violet-600
                            backgroundColor: 'rgba(124, 58, 237, 0.2)',
                            fill: false,
                            yAxisID: 'y2', // Eixo √† esquerda
                            tension: 0.1,
                        }
                    ].filter(dataset => dataset.label !== 'N/A na Opera√ß√£o Total' || isIndividual), // Filtra dataset CSAT se for Opera√ß√£o Total
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: titleText,
                            font: { size: 16 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Dia (DD/MM/YYYY)'
                            }
                        },
                        // Eixo Y2 (Esquerda) - Para Valores de Tempo (TMA, Pausas)
                        y2: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Tempo (Segundos / Minutos)',
                                color: 'rgb(249, 115, 22)',
                            },
                            grid: {
                                drawOnChartArea: false, // S√≥ o grid do y1 (direito)
                            },
                        },
                        // Eixo Y1 (Direita) - Para Contagem e Porcentagem (Chamadas, CSAT)
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Contagem / % CSAT',
                                color: 'rgb(59, 130, 246)',
                            },
                            // Configura√ß√µes para o % CSAT (se n√£o for Opera√ß√£o Total)
                            ...(isIndividual && {
                                suggestedMax: 100,
                                suggestedMin: 0,
                                ticks: {
                                    callback: function(value, index, values) {
                                        // Adiciona % se o valor for 100 ou 0, para dar contexto ao eixo Y
                                        if (value === 0 || value === 100) {
                                             return value + '%';
                                        }
                                        return value;
                                    }
                                }
                            })
                        },
                    }
                }
            });
        };

        // --- EXPORTA√á√ÉO DE CSV ---

        document.getElementById('export-button').addEventListener('click', () => {
            const table = document.getElementById('daily-results-table');
            const rows = table.querySelectorAll('tr');
            
            let csv = [];
            
            // 1. Coleta o cabe√ßalho (TH)
            const headerCells = rows[0].querySelectorAll('th');
            const header = Array.from(headerCells).map(th => th.textContent.trim());
            csv.push(header.join(DELIMITER_CSV));

            // 2. Coleta os dados (TD) da tabela VIS√çVEL (ap√≥s o filtro)
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                
                // AQUI: Usamos o textContent exato sem manipula√ß√£o de formata√ß√£o
                const rowData = Array.from(cells).map(td => td.textContent.trim()); 
                csv.push(rowData.join(DELIMITER_CSV));
            }

            // Adiciona BOM (Byte Order Mark) para garantir a correta abertura em Excel com caracteres especiais
            const csvFile = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const downloadLink = document.createElement('a');
            
            const dateStr = new Date().toISOString().split('T')[0];
            downloadLink.download = `Relatorio_Diario_Performance_Simplificado_${dateStr}.csv`;
            
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        });


        // --- EVENTO PRINCIPAL ---
        document.getElementById('process-button').addEventListener('click', processFiles);

        // --- INICIALIZA√á√ÉO ---
        window.onload = () => {
            updateProcessButtonState(); 
        };

    </script>
</body>
</html>
